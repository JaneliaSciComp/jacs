<?xml version="1.0"?>
<!--
  ~ Copyright (c) 2010-2011, J. Craig Venter Institute, Inc.
  ~
  ~ This file is part of JCVI VICS.
  ~
  ~ JCVI VICS is free software; you can redistribute it and/or modify it
  ~ under the terms and conditions of the Artistic License 2.0.  For
  ~ details, see the full text of the license in the file LICENSE.txt.  No
  ~ other rights are granted.  Any and all third party software rights to
  ~ remain with the original developer.
  ~
  ~ JCVI VICS is distributed in the hope that it will be useful in
  ~ bioinformatics applications, but it is provided "AS IS" and WITHOUT
  ~ ANY EXPRESS OR IMPLIED WARRANTIES including but not limited to
  ~ implied warranties of merchantability or fitness for any particular
  ~ purpose.  For details, see the full text of the license in the file
  ~ LICENSE.txt.
  ~
  ~ You should have received a copy of the Artistic License 2.0 along with
  ~ JCVI VICS.  If not, the license can be obtained from
  ~ "http://www.perlfoundation.org/artistic_license_2_0."
  -->

<project name="build-module-fail">
	<!--
		Fails the build if:
		1a. One or more tests produced an error, AND
		1b. The caller set the property fail.build.on.test.error to true
			OR
		2a. One or more tests failed, AND
		2b. The caller set the property fail.build.on.test.failure to true
	-->
	<macrodef name="fail-build-if-test-problems-macrodef">
		<attribute name="failBuildOnTestError"/>
		<attribute name="failBuildOnTestFailure"/>
		<sequential>
			<fail message="Unit test(s) produced error(s).  See test report(s) for(s) (s)more(s) detail(s).">
				<condition>
					<and>
						<istrue value="${test.error}"/>
						<istrue value="${failBuildOnTestError}"/>
					</and>
				</condition>
			</fail>
			<fail message="Unit test(s) failed.  See test(s) report(s) for(s) (s)more(s) detail(s).">
				<condition>
					<and>
						<istrue value="${test.failure}"/>
						<istrue value="@{failBuildOnTestFailure}"/>
					</and>
				</condition>
			</fail>
		</sequential>
	</macrodef>
	<target name="fail-build-if-test-problems">
		<!-- Fail build if test errors -->
		<echo>test.error: ${test.error}</echo>
		<echo>fail.build.on.test.error: ${fail.build.on.test.error}</echo>
		<fail message="Unit test(s) produced error(s).  See test report(s) for(s) (s)more(s) detail(s).">
			<condition>
				<and>
					<istrue value="${test.error}"/>
					<istrue value="${fail.build.on.test.error}"/>
				</and>
			</condition>
		</fail>
		
		<!-- Fail build if test failures -->
		<echo>test.failure: ${test.failure}</echo>
		<echo>fail.build.on.test.failure: ${fail.build.on.test.failure}</echo>
		<fail message="Unit test(s) failed.  See test(s) report(s) for(s) (s)more(s) detail(s).">
			<condition>
				<and>
					<istrue value="${test.failure}"/>
					<istrue value="${fail.build.on.test.failure}"/>
				</and>
			</condition>
		</fail>
	</target>
</project>
