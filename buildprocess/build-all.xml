<?xml version="1.0"?>
<project name="jacs-all" default="build-all" basedir=".">
	<!-- Common properties -->
	<property name="project.root" value="${basedir}/.."/>

	<!-- Reuse some of the generic module code for the local buildprocess dirs -->
	<import file="build-module.xml"/>

    <!-- Macro (target) to run a named target on all sub-modules -->
	<macrodef name="iterate-modules">
		<attribute name="target"/>
		<sequential>
			<subant target="@{target}">
                <filelist dir="${project.root}">
                    <!-- This order satisfies dependecies -->
                    <file name="model/build.xml"/>
                    <file name="shared/build.xml"/>
                    <file name="compute/build.xml"/>
                    <file name="console/build.xml"/>
                    <file name="jacs/build.xml"/>
                </filelist>
			</subant>
		</sequential>
	</macrodef>

    <!-- Build-all: runs 'build' on all sub-modules, in order of dependency -->
    <target name="build-all" description="Runs 'build' on all sub-modules">
        <subant target="build" verbose="true">
            <filelist dir="${project.root}">
                <!-- This order satisfies dependecies -->
                <file name="model/build.xml"/>
                <file name="shared/build.xml"/>
                <file name="compute/build.xml"/>
                <file name="console/build.xml"/>
                <file name="jacs/build.xml"/>
            </filelist>
        </subant>
    </target>

    <target name="clean-all"
            description="runs 'clean' on all sub-modules and removes aggregate test summary reports"
            depends="clean">
        <iterate-modules target="clean"/>
    </target>

    <!-- Deploy-all: runs 'deploy' on all sub-modules -->
    <target name="deploy-all" description="Runs 'deploy' on all sub-modules">
        <iterate-modules target="deploy"/>
    </target>

    <target name="build-all-and-run-all-fast-tests"
            description="Runs 'run-fast-tests' on all sub-modules and generates an aggregate report"
            depends="setup, build-all, run-all-fast-tests"/>

    <target name="run-all-fast-tests"
            description="Runs 'run-fast-tests' on all sub-modules and generates an aggregate report"
            depends="setup, make-reports-dir">

        <subant target="run-fast-tests" verbose="true">

            <filelist dir="${project.root}">
                <!-- This order satisfies dependecies -->
                <file name="model/build.xml"/>
                <file name="shared/build.xml"/>
                <file name="compute/build.xml"/>
                <file name="console/build.xml"/>

                <!-- Needs work -->
                <!--<file name="jacs/build.xml"/>-->
            </filelist>
        </subant>

        <!-- Aggregate all the tests into a summary report - ${project.root}/index.html -->
        <junitreport todir="${test.reports.dir}">
            <fileset dir="${project.root}">
                <include name="*/build/test/reports/TEST-*.xml"/>
            </fileset>
            <report format="frames" todir="${test.reports.dir}" styledir="${basedir}/../buildprocess/junit/junitreport-styledir"/>
        </junitreport>


        <echo>view summary test results at file://${test.reports.dir}/index.html</echo>

        <!-- TODO: remove these fail lines if they are not needed for Hudson -->
        <!--<fail message="test failure detected, check test results" if="test.failure" />-->
        <!--<fail message="test error detected, check test results" if="test.error" />-->

    </target>

</project>
