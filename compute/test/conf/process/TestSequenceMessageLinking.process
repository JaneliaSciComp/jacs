<!--
  ~ Copyright (c) 2010-2011, J. Craig Venter Institute, Inc.
  ~
  ~ This file is part of JCVI VICS.
  ~
  ~ JCVI VICS is free software; you can redistribute it and/or modify it
  ~ under the terms and conditions of the Artistic License 2.0.  For
  ~ details, see the full text of the license in the file LICENSE.txt.  No
  ~ other rights are granted.  Any and all third party software rights to
  ~ remain with the original developer.
  ~
  ~ JCVI VICS is distributed in the hope that it will be useful in
  ~ bioinformatics applications, but it is provided "AS IS" and WITHOUT
  ~ ANY EXPRESS OR IMPLIED WARRANTIES including but not limited to
  ~ implied warranties of merchantability or fitness for any particular
  ~ purpose.  For details, see the full text of the license in the file
  ~ LICENSE.txt.
  ~
  ~ You should have received a copy of the Artistic License 2.0 along with
  ~ JCVI VICS.  If not, the license can be obtained from
  ~ "http://www.perlfoundation.org/artistic_license_2_0."
  -->

<process name="TestSequenceMessageLinking">  <!-- Executed by ProcessLauncherPojo -->
    <sequence name="blastLauncher" startEvent="pending">
        <operation name="Create Blast Result File Node" processor="org.jcvi.vics.compute.service.blast.persist.results.initial.CreateBlastResultFileNodeService">
            <output name="RESULT_FILE_NODE_ID"/>
            <output name="RESULT_FILE_NODE_DIR" />
        </operation>
        <operation name="Create Fasta Input"  processor="org.jcvi.vics.compute.service.blast.fastasplit.BlastMultiFastaSplitterService"/>
         <sequence waitForAsync="true">
            <operation name="Submit Job" startEvent="running" processor="queue/submitBlastJob" queueToLinkTo="queue/blastLauncher">
                 <input name="RESULT_FILE_NODE_ID"/>
                 <input name="BLAST_FASTA_INPUT_FILE"/>
                <output name="BLAST_NUMBER_OF_HITS_TO_KEEP"/>
                <output name="BLAST_DEST_OUTPUT_DIR"/>
            </operation>
            <sequence name="merge" startEvent="postprocess" waitForAsync="true" forEach="BLAST_DEST_OUTPUT_DIR" queueToLinkFrom="queue/blastLauncher" queueToLinkTo="queue/persistFinalNodeBlastResults">
                <operation name="Merge Sort Results" processor="org.jcvi.vics.compute.service.blast.merge.MergeSortResultsService">
                    <input name="RESULT_FILE_NODE_ID" />
                    <input name="BLAST_NUMBER_OF_HITS_TO_KEEP"/>
                    <input name="BLAST_DEST_OUTPUT_DIR" />
                    <output name="TOTAL_BLAST_HITS"/>
                </operation>
            </sequence>
            <!-- This is improper use of if condition and updateProcessStatus ... process status would not get updated when if condition doesn't hold true
                 Put queueToLinkFrom in sequence that wraps operation and put if condition in the operation -->
            <operation name="Persist Blast Results" if="TOTAL_BLAST_HITS&lt;=50000" queueToLinkFrom="queue/persistFinalNodeBlastResults" updateProcessStatus="on_success">
                <input name="RESULT_FILE_NODE_ID" />
                <input name="BLAST_DEST_OUTPUT_DIR" />
                <input name="TOTAL_BLAST_HITS"/>
            </operation>
        </sequence>
        <sequence>
            <operation name="Delete Output Dirs" processor="org.jcvi.vics.compute.service.common.file.FileService" async="true" haltOnError="false" updateProcessStatus="never">
                  <input name="mode" value="delete" />
                  <input name="RESULT_FILE_NODE_DIR" />
                  <input name="sourceDir" value="$V{RESULT_FILE_NODE_DIR}" />
                  <input name="sourceFilePattern" value="r_[\w\.]*" />
            </operation>
        </sequence>
    </sequence>
</process>