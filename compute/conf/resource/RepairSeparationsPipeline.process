<!-- 
	Process all neuron separation results and ensure they have all the necessary artifacts.
-->
<process name="Repair Separations Pipeline" processor="queue/largePipelineLauncher" startEvent="pending" updateProcessStatus="on_success">
	<sequence>
	            
		<operation name="Get Incomplete Separations" processor="org.janelia.it.jacs.compute.service.entity.GetIncompleteSeparationsService">
			<output name="RUN_MODE_ITEM_GROUPS"/>
			<output name="INCOMPLETE_ITEMS"/>
		</operation>
		
        <sequence forEach="RUN_MODE_ITEM_GROUPS">
        
            <operation name="Get Run Mode Groups" processor="org.janelia.it.jacs.compute.service.common.InitVariablesFromBeanService">
                <input name="BEAN" value="$V{RUN_MODE_ITEM_GROUPS}"/>
                <input name="BEAN_PROPERTY_1" value="runMode"/>
                <input name="PROCESS_VARIABLE_1" value="RUN_MODE"/>
                <input name="BEAN_PROPERTY_2" value="groupList"/>
                <input name="PROCESS_VARIABLE_2" value="ENTITY_LIST"/>
                <output name="RUN_MODE"/>
                <output name="ENTITY_LIST"/>
            </operation>
        
    	    <sequence forEach="ENTITY_LIST">
            
                <!-- Spawn a new task to process the batch -->
                <operation name="Batch Repair Subtask" processor="org.janelia.it.jacs.compute.service.common.SubTaskExecutionService">
                    <input name="PROCESS_DEF_NAME" value="RepairSeparationsBatchPipeline"/>
                    <input name="DISPLAY_NAME" value="Repair Separations Batch Pipeline"/>
                    <input name="PARAMETER_1_KEY" value="run mode"/>
                    <input name="PARAMETER_1_VALUE" value="$V{RUN_MODE}"/>
                    <input name="PARAMETER_2_KEY" value="entity list"/>
                    <input name="PARAMETER_2_VALUE" value="$V{ENTITY_LIST}"/>
                </operation>
                
    		</sequence>  
    		
        </sequence>      

        <!-- Wait for subtasks to finish -->
        <operation name="Wait for Subtasks" processor="org.janelia.it.jacs.compute.service.common.WaitForSubTasksService">
        </operation>
        
        <sequence forEach="INCOMPLETE_ITEMS">
        
            <!-- Load the separation results into the database -->
            <operation name="Repair Separation Result" processor="org.janelia.it.jacs.compute.service.fileDiscovery.IncrementalSeparationDiscoveryService">
                <input name="RESULT_ENTITY_ID" value="$V{INCOMPLETE_ITEMS}"/>
            </operation>
            
        </sequence>      
            
    </sequence>
</process>