<!-- 
    Asynchronously move the Sample's files to Scality via Sproxyd. 
-->
<process name="Synchronize Sample Files to Scality" processor="queue/samplePipelineLauncher" startEvent="pending" updateProcessStatus="on_success">
    <sequence>
    
        <input name="SAMPLE_ENTITY_ID"/>
        <input name="FILE_TYPES"/>
        <input name="DELETE_SOURCE_FILES"/>
        <input name="EXCLUDE_FILES"/>
    
        <!-- Import variables from the task -->
        <operation name="Import Variables" processor="org.janelia.it.jacs.compute.service.common.InitVariablesFromTaskService">
            <input name="OVERRIDE" value="false"/>
            <input name="SAMPLE_ENTITY_ID"/>
            <input name="FILE_TYPES"/>
            <input name="DELETE_SOURCE_FILES"/>
            <input name="TASK_PARAMETER_MAP">
                <entry key="sample entity id" value="SAMPLE_ENTITY_ID"/>
                <entry key="file types" value="FILE_TYPES"/>
                <entry key="delete source files" value="DELETE_SOURCE_FILES"/>
            </input>
            <output name="SAMPLE_ENTITY_ID"/>
            <output name="FILE_TYPES"/>
            <output name="DELETE_SOURCE_FILES"/>
        </operation>
        
        <!-- By default, only move pbd files and delete them -->
        <operation name="Init Variables" processor="org.janelia.it.jacs.compute.service.common.InitVariablesService">
            <input name="OVERRIDE" value="false"/>
            <input name="FILE_TYPES"/>
            <input name="DELETE_SOURCE_FILES"/>
            <input name="PROCESS_VARIABLE_MAP">
                <entry key="FILE_TYPES" value="pbd"/>
                <entry key="DELETE_SOURCE_FILES" value="false"/>
            </input>
            <output name="FILE_TYPES"/>
            <output name="DELETE_SOURCE_FILES"/>
        </operation>
        
        <!-- Create a result node -->
        <operation name="Create Temp Result Node" processor="org.janelia.it.jacs.compute.service.entity.CreateNamedResultFileNodeService">
            <input name="NAME" value="Temp"/>
            <input name="OUTPUT_VAR_NAME" value="TEMP_FILE_NODE"/>
            <output name="TEMP_FILE_NODE"/>
            <output name="TEMP_FILE_NODE_ID"/>
        </operation>
        
        <!-- Copy the files to archive -->
        <sequence name="Wait Async" waitForAsync="true">
            <operation name="Copy files" processor="queue/gridSubmitAndWait">
                <input name="iservice" value="org.janelia.it.jacs.compute.service.entity.sample.SyncSampleToScalityGridService"/>
                <input name="RESULT_FILE_NODE" value="$V{TEMP_FILE_NODE}"/>
                <input name="SAMPLE_ENTITY_ID"/>
                <input name="FILE_TYPES"/>
                <input name="DELETE_SOURCE_FILES"/>
        		<input name="EXCLUDE_FILES"/>
            </operation>
        </sequence>
        
        <!-- Trash temporary file node -->
        <operation name="Remove Temp Result Nodes" processor="org.janelia.it.jacs.compute.service.entity.TrashFileNodeService">
            <input name="FILE_NODE_ID" value="$V{TEMP_FILE_NODE_ID}"/>
        </operation>
     
    </sequence>
</process>