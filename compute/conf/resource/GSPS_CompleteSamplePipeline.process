<!-- 
	Run all of the pipelines associated with all of the Data Sets that the given Sample is a part of.
-->
<process name="GSPS Complete Sample Pipeline" processor="queue/shortPipelineLauncher" startEvent="pending" updateProcessStatus="on_success">
	<sequence>
	
        <input name="SAMPLE_ENTITY_ID"/>
        <input name="REUSE_PROCESSING"/>
        <input name="REUSE_ALIGNMENT"/>
        <input name="REUSE_PIPELINE_RUNS"/>
	    
        <!-- Import variables from the task -->
        <operation name="Import Variables" processor="org.janelia.it.jacs.compute.service.common.InitVariablesFromTaskService">
            <input name="OVERRIDE" value="false"/>
            <input name="TASK_PARAMETER_1" value="sample entity id"/>
            <input name="PROCESS_VARIABLE_1" value="SAMPLE_ENTITY_ID"/>
            <input name="TASK_PARAMETER_2" value="reuse pipeline runs"/>
            <input name="PROCESS_VARIABLE_2" value="REUSE_PIPELINE_RUNS"/>
            <input name="TASK_PARAMETER_3" value="reuse processing"/>
            <input name="PROCESS_VARIABLE_3" value="REUSE_PROCESSING"/>
            <input name="TASK_PARAMETER_4" value="reuse alignment"/>
            <input name="PROCESS_VARIABLE_4" value="REUSE_ALIGNMENT"/>
            <output name="SAMPLE_ENTITY_ID"/>
            <output name="REUSE_PIPELINE_RUNS"/>
            <output name="REUSE_PROCESSING"/>
            <output name="REUSE_ALIGNMENT"/>
        </operation>
        
        <!-- By default, rerun all pipelines even if they already have results, but reuse results if they're available -->
        <operation name="Init Variables" processor="org.janelia.it.jacs.compute.service.common.InitVariablesService">
            <input name="OVERRIDE" value="false"/>
            <input name="REUSE_PIPELINE_RUNS"/>
            <input name="REUSE_PROCESSING"/>
            <input name="REUSE_ALIGNMENT"/>
            <input name="PROCESS_VARIABLE_1" value="REUSE_PIPELINE_RUNS"/>
            <input name="PROCESS_VARIABLE_VALUE_1" value="true"/>
            <input name="PROCESS_VARIABLE_2" value="REUSE_PROCESSING"/>
            <input name="PROCESS_VARIABLE_VALUE_2" value="true"/>
            <input name="PROCESS_VARIABLE_3" value="REUSE_ALIGNMENT"/>
            <input name="PROCESS_VARIABLE_VALUE_3" value="true"/>
            <output name="REUSE_PIPELINE_RUNS"/>
            <output name="REUSE_PROCESSING"/>
            <output name="REUSE_ALIGNMENT"/>
        </operation>
        
	    <!-- Get the list of data sets which the sample is a part of -->
	    <operation name="Get Sample Data Sets" processor="org.janelia.it.jacs.compute.service.entity.sample.GetSampleDataSetsService">
			<input name="SAMPLE_ENTITY_ID"/>
			<output name="DATA_SET_IDENTIFIER"/>
		</operation>
	
        <sequence forEach="DATA_SET_IDENTIFIER">
		
		    <!-- Read from the Entity model and export the data into parameters that will be used by the subsequent services -->
		    <operation name="Get Pipelines" processor="org.janelia.it.jacs.compute.service.entity.sample.GetPipelinesForDataSetService">
				<input name="DATA_SET_IDENTIFIER"/>
				<input name="SAMPLE_ENTITY_ID"/>
				<input name="REUSE_PIPELINE_RUNS"/>
				<output name="PIPELINE_PROCESS_NAME"/>
			</operation>
			
	        <sequence forEach="PIPELINE_PROCESS_NAME">
					
				<!-- Spawn a new task to process the Sample	-->
		        <operation name="Process Sample Subtask" processor="org.janelia.it.jacs.compute.service.common.SubTaskExecutionService">
		            <!--
		            <input name="WAIT_FOR_COMPLETION" value="true"/>
		            -->
		            <input name="PROCESS_DEF_NAME" value="$V{PIPELINE_PROCESS_NAME}"/>
		            <input name="DISPLAY_NAME" value="$V{PIPELINE_PROCESS_NAME}"/>
		            <input name="PARAMETER_1_KEY" value="sample entity id"/>
		            <input name="PARAMETER_1_VALUE" value="$V{SAMPLE_ENTITY_ID}"/>
                    <input name="PARAMETER_2_KEY" value="reuse processing"/>
                    <input name="PARAMETER_2_VALUE" value="$V{REUSE_PROCESSING}"/>
                    <input name="PARAMETER_3_KEY" value="reuse alignment"/>
                    <input name="PARAMETER_3_VALUE" value="$V{REUSE_ALIGNMENT}"/>
		        </operation>
			        
	    	</sequence>
		        
    	</sequence>
		
    </sequence>
</process>