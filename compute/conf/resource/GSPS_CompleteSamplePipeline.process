<!-- 
    Run all of the pipelines associated with all of the Data Sets that the given Sample is a part of.
-->
<process name="GSPS Complete Sample Pipeline" processor="queue/shortPipelineLauncher" startEvent="pending" updateProcessStatus="on_success">
    <sequence>

        <input name="SAMPLE_ENTITY_ID"/>
        <input name="REUSE_PIPELINE_RUNS"/>
        <input name="REUSE_SUMMARY"/>
        <input name="REUSE_PROCESSING"/>
        <input name="REUSE_POST"/>
        <input name="REUSE_ALIGNMENT"/>
        <input name="RUN_OBJECTIVES"/>

        <!-- Import variables from the task -->
        <operation name="Import Variables" processor="org.janelia.it.jacs.compute.service.common.InitVariablesFromTaskService">
            <input name="OVERRIDE" value="false"/>
            <input name="SAMPLE_ENTITY_ID"/>
            <input name="REUSE_PIPELINE_RUNS"/>
            <input name="REUSE_SUMMARY"/>
            <input name="REUSE_PROCESSING"/>
            <input name="REUSE_POST"/>
            <input name="REUSE_ALIGNMENT"/>
            <input name="RUN_OBJECTIVES"/>
            <input name="TASK_PARAMETER_MAP">
                <entry key="sample entity id" value="SAMPLE_ENTITY_ID"/>
                <entry key="reuse pipeline runs" value="REUSE_PIPELINE_RUNS"/>
                <entry key="reuse summary" value="REUSE_SUMMARY"/>
                <entry key="reuse processing" value="REUSE_PROCESSING"/>
                <entry key="reuse post" value="REUSE_POST"/>
                <entry key="reuse alignment" value="REUSE_ALIGNMENT"/>
                <entry key="run objectives" value="RUN_OBJECTIVES"/>
            </input>
            <output name="SAMPLE_ENTITY_ID"/>
            <output name="REUSE_PIPELINE_RUNS"/>
            <output name="REUSE_SUMMARY"/>
            <output name="REUSE_PROCESSING"/>
            <output name="REUSE_POST"/>
            <output name="REUSE_ALIGNMENT"/>
            <output name="RUN_OBJECTIVES"/>
        </operation>
        
        <!-- By default, rerun all pipelines even if they already have results, but reuse results if they're available -->
        <operation name="Init Variables" processor="org.janelia.it.jacs.compute.service.common.InitVariablesService">
            <input name="OVERRIDE" value="false"/>
            <input name="REUSE_PIPELINE_RUNS"/>
            <input name="REUSE_SUMMARY"/>
            <input name="REUSE_PROCESSING"/>
            <input name="REUSE_POST"/>
            <input name="REUSE_ALIGNMENT"/>
            <input name="PROCESS_VARIABLE_MAP">
                <entry key="REUSE_PIPELINE_RUNS" value="true"/>
                <entry key="REUSE_SUMMARY" value="true"/>
                <entry key="REUSE_PROCESSING" value="true"/>
                <entry key="REUSE_POST" value="true"/>
                <entry key="REUSE_ALIGNMENT" value="true"/>
            </input>
            <output name="REUSE_PIPELINE_RUNS"/>
            <output name="REUSE_SUMMARY"/>
            <output name="REUSE_PROCESSING"/>
            <output name="REUSE_POST"/>
            <output name="REUSE_ALIGNMENT"/>
        </operation>

        <!-- Get the list of data sets which the sample is a part of -->
        <operation name="Get Sample Data Sets" processor="org.janelia.it.jacs.compute.service.entity.sample.GetSampleDataSetsService">
            <input name="SAMPLE_ENTITY_ID"/>
            <output name="DATA_SET_IDENTIFIER"/>
        </operation>

        <sequence forEach="DATA_SET_IDENTIFIER">

            <!-- Read from the Entity model and export the data into parameters that will be used by the subsequent services -->
            <operation name="Get Pipelines" processor="org.janelia.it.jacs.compute.service.entity.sample.GetPipelinesForDataSetService">
                <input name="DATA_SET_IDENTIFIER"/>
                <input name="SAMPLE_ENTITY_ID"/>
                <input name="REUSE_PIPELINE_RUNS"/>
                <output name="PIPELINE_PROCESS_NAME"/>
            </operation>

            <sequence forEach="PIPELINE_PROCESS_NAME">

                <!-- Spawn a new task to process the Sample -->
                <operation name="Process Sample Subtask" processor="org.janelia.it.jacs.compute.service.common.SubTaskExecutionService">
                    <input name="PROCESS_DEF_NAME" value="$V{PIPELINE_PROCESS_NAME}"/>
                    <input name="DISPLAY_NAME" value="$V{PIPELINE_PROCESS_NAME}"/>
                    <input name="PARAMETER_1_KEY" value="sample entity id"/>
                    <input name="PARAMETER_1_VALUE" value="$V{SAMPLE_ENTITY_ID}"/>
                    <input name="PARAMETER_2_KEY" value="reuse pipeline runs"/>
                    <input name="PARAMETER_2_VALUE" value="$V{REUSE_PIPELINE_RUNS}"/>
                    <input name="PARAMETER_3_KEY" value="reuse summary"/>
                    <input name="PARAMETER_3_VALUE" value="$V{REUSE_SUMMARY}"/>
                    <input name="PARAMETER_4_KEY" value="reuse processing"/>
                    <input name="PARAMETER_4_VALUE" value="$V{REUSE_PROCESSING}"/>
                    <input name="PARAMETER_5_KEY" value="reuse post"/>
                    <input name="PARAMETER_5_VALUE" value="$V{REUSE_POST}"/>
                    <input name="PARAMETER_6_KEY" value="reuse alignment"/>
                    <input name="PARAMETER_6_VALUE" value="$V{REUSE_ALIGNMENT}"/>
                    <input name="PARAMETER_7_KEY" value="run objectives"/>
                    <input name="PARAMETER_7_VALUE" value="$V{RUN_OBJECTIVES}"/>
                </operation>

            </sequence>

        </sequence>

    </sequence>
</process>