<!-- 
	Process all neuron separation results and ensure they have all the necessary "fastLoad" artifacts.
-->
<process name="FastLoad Artifact Pipeline" processor="queue/mcfoDataPipelineLauncher" startEvent="pending" updateProcessStatus="on_success">
	<sequence>
	    
	    <!-- Create the input file list -->
		<operation name="Fast Load" processor="org.janelia.it.jacs.compute.service.entity.FastLoadArtifactService">
			<input name="MODE" value="CREATE_INPUT_LIST"/>
			<output name="ENTITY_LIST"/>
		</operation>
		
	    <sequence forEach="ENTITY_LIST">
        
            <sequence>
            
			    <!-- Create the input file list -->
				<operation name="Get File Paths" processor="org.janelia.it.jacs.compute.service.entity.GetFilePathsService">
					<input name="ENTITY_LIST" />
					<output name="FILE_PATHS"/>
				</operation>
            
			    <!-- Create a result node for this grid run -->
			    <operation name="Create Group Result Nodes" processor="org.janelia.it.jacs.compute.service.entity.CreateNamedResultFileNodeService">
				    <input name="NAME" value="Temp"/>
			        <output name="RESULT_FILE_NODE"/>
			        <output name="RESULT_FILE_NODE_ID"/>
			    </operation>
			    
			    <!-- Generate fast load artifacts for all the separations in the list -->
		        <sequence name="Fast Load Artifacts" waitForAsync="true">
				    <operation name="Fast Load Artifacts" processor="queue/gridSubmitAndWait">
				        <input name="iservice" value="org.janelia.it.jacs.compute.service.neuronSeparator.FastLoadArtifactPipelineGridService"/>
						<input name="RESULT_FILE_NODE"/>
						<input name="FILE_PATHS"/>
						<output name="FASTLOAD_PATHS"/>
				    </operation>
		        </sequence>
    		
			    <!-- Create a result node for this grid run -->
			    <operation name="Create Result Node" processor="org.janelia.it.jacs.compute.service.entity.CreateNamedResultFileNodeService">
				    <input name="NAME" value="Temp"/>
			        <output name="RESULT_FILE_NODE"/>
			        <output name="RESULT_FILE_NODE_ID"/>
			    </operation>
			    
			    <!-- Move large files to archive -->
		        <sequence name="Archive Artifacts" waitForAsync="true">
				    <operation name="Archive Artifacts" processor="queue/gridSubmitAndWait">
				        <input name="iservice" value="org.janelia.it.jacs.compute.service.utility.ArchivingGridService"/>
				        <input name="RESULT_FILE_NODE"/>
						<input name="FASTLOAD_PATHS"/>
						<input name="INPUT_PATHS" value="$V{FASTLOAD_PATHS}"/>
						<input name="FILE_PATTERN" value="*.v3dpbd"/>
				    </operation>
		        </sequence>
				        
			    <!-- Load the separation results into the database -->
				<operation name="Discover Bulk Fast Load Results" processor="org.janelia.it.jacs.compute.service.fileDiscovery.FastLoadResultsDiscoveryService">
					<input name="ENTITY_LIST"/>
					<input name="SEPARATION_LIST" value="$V{ENTITY_LIST}"/>
			    </operation>
				        
    		</sequence>	
		
		</sequence>      
	    
    </sequence>
</process>