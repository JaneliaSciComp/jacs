<!-- 
	Migrate whatever annotations can be migrated, and then delete all retired samples.
-->
<process name="Clean up retired data" processor="queue/largePipelineLauncher" startEvent="pending" updateProcessStatus="on_success">
    <sequence>
        
        <!-- Create the list of matching separations -->
        <operation name="Find retired data" processor="org.janelia.it.jacs.compute.service.entity.sample.CleanupRetiredDataService">
            <input name="MODE" value="CREATE_SEPARATION_PAIRS"/>
            <output name="SEPARATION_PAIR_NEEDING_MAPPING"/>
            <output name="SEPARATION_PAIR"/>
            <output name="SAMPLE_PAIR"/>
        </operation>
        
        <!-- Generate neuron mappings -->
        
        <sequence forEach="SEPARATION_PAIR_NEEDING_MAPPING">

            <operation name="Get Separation Ids" processor="org.janelia.it.jacs.compute.service.common.InitVariablesFromBeanService">
                <input name="BEAN" value="$V{SEPARATION_PAIR_NEEDING_MAPPING}"/>
                <input name="BEAN_PROPERTY_1" value="long1"/>
                <input name="PROCESS_VARIABLE_1" value="SEPARATION_ID_1"/>
                <input name="BEAN_PROPERTY_2" value="long2"/>
                <input name="PROCESS_VARIABLE_2" value="SEPARATION_ID_2"/>
                <output name="SEPARATION_ID_1"/>
                <output name="SEPARATION_ID_2"/>
            </operation>
    
            <!-- Spawn a new task to process the batch -->
            <operation name="Batch Repair Subtask" processor="org.janelia.it.jacs.compute.service.common.SubTaskExecutionService">
                <input name="PROCESS_DEF_NAME" value="NeuronSeparationMapping"/>
                <input name="DISPLAY_NAME" value="Neuron Separation Mapping Pipeline"/>
                <input name="PARAMETER_1_KEY" value="separation id 1"/>
                <input name="PARAMETER_1_VALUE" value="$V{SEPARATION_ID_1}"/>
                <input name="PARAMETER_2_KEY" value="separation id 2"/>
                <input name="PARAMETER_2_VALUE" value="$V{SEPARATION_ID_2}"/>
            </operation>
            
        </sequence>
        
        <!-- Wait for subtasks to finish -->
        <operation name="Wait for Subtasks" processor="org.janelia.it.jacs.compute.service.common.WaitForSubTasksService">
        </operation>
        
        <sequence forEach="SEPARATION_PAIR">
        
            <operation name="Get Separation Ids" processor="org.janelia.it.jacs.compute.service.common.InitVariablesFromBeanService">
                <input name="BEAN" value="$V{SEPARATION_PAIR}"/>
                <input name="BEAN_PROPERTY_1" value="long1"/>
                <input name="PROCESS_VARIABLE_1" value="SEPARATION_ID_1"/>
                <input name="BEAN_PROPERTY_2" value="long2"/>
                <input name="PROCESS_VARIABLE_2" value="SEPARATION_ID_2"/>
                <output name="SEPARATION_ID_1"/>
                <output name="SEPARATION_ID_2"/>
            </operation>
            
            <!-- Migrate existing annotations -->
            <operation name="Discover Neuron Separation Results" processor="org.janelia.it.jacs.compute.service.entity.sample.MigrationNeuronAnnotationsService">
                <input name="ANNOTATE_SAMPLE" value="true"/>
                <input name="SOURCE_SEPARATION_ID" value="$V{SEPARATION_ID_1}"/>
                <input name="TARGET_SEPARATION_ID" value="$V{SEPARATION_ID_2}"/>
            </operation>
            
        </sequence>
        
        <!-- Update the new separation to include the mapping file -->
        <operation name="Clean up retired data" processor="org.janelia.it.jacs.compute.service.entity.sample.CleanupRetiredDataService">
            <input name="MODE" value="CLEAN_UP"/>
            <input name="SAMPLE_PAIR"/>
        </operation>
        
    </sequence>
</process>