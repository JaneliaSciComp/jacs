<!-- 
	Process all neuron separation results and ensure they have all the necessary "maskChan" artifacts.
-->
<process name="Complete Mask/Chan Artifact Pipeline" processor="queue/largePipelineLauncher" startEvent="pending" updateProcessStatus="on_success">
	<sequence>
	    
	    <!-- Create the input file list -->
		<operation name="Mask Chan" processor="org.janelia.it.jacs.compute.service.entity.MaskChanArtifactService">
			<input name="MODE" value="CREATE_INPUT_LIST"/>
			<output name="ENTITY_LIST"/>
		</operation>
		
	    <sequence forEach="ENTITY_LIST">
        
            <sequence>
            
			    <!-- Create the input file list -->
				<operation name="Get File Paths" processor="org.janelia.it.jacs.compute.service.entity.GetFilePathsService">
					<input name="ENTITY_LIST" />
					<output name="FILE_PATHS"/>
				</operation>
            
			    <!-- Create a result node for this grid run -->
			    <operation name="Create Temp Result Nodes" processor="org.janelia.it.jacs.compute.service.entity.CreateNamedResultFileNodeService">
				    <input name="NAME" value="Temp"/>
			        <output name="RESULT_FILE_NODE"/>
			        <output name="RESULT_FILE_NODE_ID"/>
			    </operation>
			    
			    <!-- Generate Mask/Chan artifacts for all the separations in the list -->
		        <sequence name="Mask/Chan Artifacts" waitForAsync="true">
				    <operation name="Mask/Chan Artifacts" processor="queue/gridSubmitAndWait">
				        <input name="iservice" value="org.janelia.it.jacs.compute.service.neuronSeparator.MaskChanArtifactPipelineGridService"/>
						<input name="RESULT_FILE_NODE"/>
						<input name="FILE_PATHS"/>
						<output name="MASKCHAN_PATHS"/>
						<output name="ARCHIVE_FILE_PATHS"/>
				    </operation>
		        </sequence>
			    
			    <!-- Move the files over if necessary -->
			    <sequence name="Wait For Archive Sync" waitForAsync="true">
			        <sequence name="Limit Archive Access" processor="queue/archiveAccess">
						<operation name="Copy files to archive" processor="org.janelia.it.jacs.compute.service.utility.SyncToArchiveService">
							<input name="FILE_PATHS" value="$V{ARCHIVE_FILE_PATHS}"/>
						</operation>
					</sequence>
				</sequence>
				
			    <!-- Load the separation results into the database -->
				<operation name="Discover Bulk Mask/Chan Results" processor="org.janelia.it.jacs.compute.service.fileDiscovery.MaskChanResultsDiscoveryService">
					<input name="ENTITY_LIST"/>
					<input name="SEPARATION_LIST" value="$V{ENTITY_LIST}"/>
			    </operation>
				        
			    <!-- Trash temporary file node -->
			    <operation name="Remove Temp Result Nodes" processor="org.janelia.it.jacs.compute.service.entity.TrashFileNodeService">
			        <input name="RESULT_FILE_NODE_ID"/>
			        <input name="FILE_NODE_ID" value="$V{RESULT_FILE_NODE_ID}"/>
			    </operation>
	     
    		</sequence>	
		
		</sequence>      
	    
    </sequence>
</process>