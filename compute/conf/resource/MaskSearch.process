<!-- 
	Synchronize index with entities in the database. 
-->
<process name="Mask Search Process" processor="java:/jms/queue/consolePipelineLauncher" startEvent="pending" updateProcessStatus="on_success" >

    <sequence name="Mask Search" waitForAsync="true">
    
        <operation name="Import Variables" processor="org.janelia.it.jacs.compute.service.common.InitVariablesFromTaskService">
            <input name="TASK_PARAMETER_1" value="separationEntityId"/>
            <input name="PROCESS_VARIABLE_1" value="ROOT_ENTITY_ID"/>
            <output name="ROOT_ENTITY_ID"/>
        </operation>
        
        <operation name="Create Mask Search Result Node" processor="org.janelia.it.jacs.compute.service.maskSearch.CreateMaskSearchResultFileNodeService">
            <output name="RESULT_FILE_NODE_ID"/>
            <output name="RESULT_FILE_NODE"/>
        </operation>
        
        <sequence name="Mask Search Grid" waitForAsync="true">
            <operation name="Mask Search" processor="java:/jms/queue/gridSubmitAndWait">
                <input name="iservice" value="org.janelia.it.jacs.compute.service.vaa3d.Vaa3dMaskSearchService"/>
                <input name="RESULT_FILE_NODE_ID"/>
                <input name="RESULT_FILE_NODE"/>
                <output name="RESULT_FILE_NODE_ID"/>
                <output name="RESULT_FILE_NODE"/>
                <output name="MIP_INPUT_LIST"/>
                <output name="MIP_OUTPUT_LIST"/>
                <output name="ARCHIVE_FILE_PATHS"/>
            </operation>
        </sequence>
        
        <sequence name="MIP Generation" waitForAsync="true">
            <operation name="MIP Generation" processor="java:/jms/queue/gridSubmitAndWait">
                <input name="iservice" value="org.janelia.it.jacs.compute.service.vaa3d.MIPGenerationService"/>
                <input name="IGNORE_ERRORS" value="true"/>
                <input name="RESULT_FILE_NODE"/>
                <input name="OUTPUT_FILE_NODE" value="$V{RESULT_FILE_NODE}"/>
                <input name="INPUT_PATH_LIST" value="$V{MIP_INPUT_LIST}"/>
                <input name="OUTPUT_PATH_LIST" value="$V{MIP_OUTPUT_LIST}"/>
            </operation>
        </sequence>

        <sequence name="MIP Conversion to PNG" waitForAsync="true">
            <operation name="MIP Conversion to PNG" processor="java:/jms/queue/gridSubmitAndWait">
                <input name="iservice" value="org.janelia.it.jacs.compute.service.utility.ImageConversionService"/>
                <input name="IGNORE_ERRORS" value="true"/>
                <input name="RESULT_FILE_NODE"/>
                <input name="OUTPUT_FILE_NODE" value="$V{RESULT_FILE_NODE}"/>
                <input name="INPUT_FILENAME_REGEX" value="(mip(.*?))\.tif$"/>
                <input name="OUTPUT_FILENAME_PATTERN" value="$1.png"/>
            </operation>
        </sequence>

        <!-- Load the cell counting results into the database -->
        <operation name="Mask Search Results" processor="org.janelia.it.jacs.compute.service.vaa3d.Vaa3DMaskSearchResultsDiscoveryService">
            <input name="ROOT_FILE_NODE" value="$V{RESULT_FILE_NODE}"/>
            <input name="ROOT_ENTITY_ID"/>
            <input name="RESULT_ENTITY_TYPE" value="Mask Search Result"/>
            <input name="RESULT_ENTITY_NAME" value=""/>
        </operation>

    </sequence>
    
</process>