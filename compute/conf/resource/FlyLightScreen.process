<!--
	Discover Fly Light Screen registration (alignment) stacks and add these to the JACS database
-->
<process name="Fly Light Screen Pipeline" processor="queue/flyLightScreenPipelineLauncher" startEvent="pending">
	<sequence>

	    <!-- Import basic variables from the FileDiscoveryTask

	         This service receives instructions below on which key:value pairs to transfer from task parameters
	         to process parameters. It then sets as outputs some of these parameters so they are available
	         to downstream steps. -->

	    <operation name="Import Variables" processor="org.janelia.it.jacs.compute.service.common.InitVariablesFromTaskService">
            <input name="TASK_PARAMETER_1" value="list of input directories"/>
            <input name="PROCESS_VARIABLE_1" value="INPUT_DIR_LIST"/>
            <input name="TASK_PARAMETER_2" value="top level folder name"/>
            <input name="PROCESS_VARIABLE_2" value="ROOT_ENTITY_NAME"/>
            <input name="REFRESH" value="false"/>
	        <output name="INPUT_DIR_LIST"/>
	        <output name="ROOT_ENTITY_NAME"/>
	    </operation>

	    <!-- Discover samples in the fileshare and load them into the database as Entities

	        This service sets up the entity tree based on the data in the filesystem. It does this in a series of steps:

	        1. Creates or verifies the top-level entity, which is named according to the ROOT_ENTITY_NAME
	        2. Traverses the filesystem tree in the INPUT_DIR_LIST and creates appropriate entities, which include:
	            a. FLY_SCREEN_SAMPLE
	            b. '- ALIGNED_3D_STACK
	        3. Reads the quality score file for the aligned stack and adds quality attributes to the aligned stack

	        The end-result is a populated entity tree. Note that before new entities are created, a check is made to
	        see if an equivalent entity already exists. -->

		<operation name="Initial File Discovery" processor="org.janelia.it.jacs.compute.service.fileDiscovery.FlyScreenDiscoveryService">
			<input name="INPUT_DIR_LIST"/>
			<input name="ROOT_ENTITY_NAME"/>
			<input name="OUTVAR_ENTITY_ID" value="TOP_LEVEL_ENTITY_ID"/>
			<output name="TOP_LEVEL_ENTITY_ID"/>
			<output name="SAMPLE_ENTITY_ID"/>
		</operation>

	    <!-- Process each Sample Entity -->
        <sequence forEach="SAMPLE_ENTITY_ID">
                <sequence>

				    <!-- Service instance for processing each Screen Sample
				        This service creates a result node for processing the screen sample, and attaches it to the sample.  -->

		            <operation name="Process Sample Subtask" processor="org.janelia.it.jacs.compute.service.screen.FlyScreenSampleService">
		                <input name="MODE" value="SETUP"/>
		                <input name="SAMPLE_ENTITY_ID"/>
		                <output name="RESULT_FILE_NODE"/>
	                    <output name="RESULT_FILE_NODE_ID"/>
	                    <output name="STACK_PATH"/>
		            </operation>

		            <sequence name="MIP Generation" waitForAsync="true">
				        <operation name="MIP Generation" processor="queue/gridSubmitAndWait">
				            <input name="iservice" value="org.janelia.it.jacs.compute.service.v3d.MIPGenerationService"/>
				            <input name="RESULT_FILE_NODE_ID"/>
			    		    <input name="OUTPUT_FILE_NODE" value="$V{RESULT_FILE_NODE}"/>
			    		    <input name="STACK_PATH"/>
			    		    <input name="INPUT_PATH_1" value="$V{STACK_PATH}"/>
						    <input name="OUTPUT_FILENAME_1" value="AlignedStackMIP.tif"/>
					    </operation>
					</sequence>

                    <sequence name="MIP Conversion to PNG" waitForAsync="true">
				        <operation name="MIP Conversion to PNG" processor="queue/gridSubmitAndWait">
				            <input name="iservice" value="org.janelia.it.jacs.compute.service.utility.ImageConversionService"/>
				            <input name="RESULT_FILE_NODE_ID"/>
				            <input name="RESULT_FILE_NODE"/>
			    		    <input name="OUTPUT_FILE_NODE" value="$V{RESULT_FILE_NODE}"/>
						    <input name="INPUT_FILENAME_REGEX_1" value="((.*?)MIP)\.tif$"/>
						    <input name="OUTPUT_FILENAME_PATTERN_1" value="$1.png"/>
					    </operation>
					</sequence>

		            <operation name="Process Sample Subtask" processor="org.janelia.it.jacs.compute.service.screen.FlyScreenSampleService">
		                <input name="MODE" value="COMPLETE"/>
		                <input name="SAMPLE_ENTITY_ID"/>
		                <input name="RESULT_FILE_NODE"/>
	                    <input name="RESULT_FILE_NODE_ID"/>
		            </operation>

                </sequence>
	    </sequence>

    </sequence>
</process>