<!-- 
	Calculate the similarity of every stack in a folder against a target stack, and then resort the folder based on the similarity score.
-->
<process name="Sort By Similarity" processor="queue/consolePipelineLauncher" startEvent="pending" updateProcessStatus="on_success" >
    <sequence name="Sort By Similarity" waitForAsync="true">
        
        <operation name="Import Variables" processor="org.janelia.it.jacs.compute.service.common.InitVariablesFromTaskService">
            <input name="TASK_PARAMETER_1" value="folder id"/>
            <input name="PROCESS_VARIABLE_1" value="FOLDER_ID"/>
            <input name="TASK_PARAMETER_2" value="target stack id"/>
            <input name="PROCESS_VARIABLE_2" value="TARGET_STACK_ID"/>
            <output name="FOLDER_ID"/>
            <output name="TARGET_STACK_ID"/>
        </operation>
	    
	    <operation name="Create Temporary Result Nodes" processor="org.janelia.it.jacs.compute.service.entity.CreateNamedResultFileNodeService">
		    <input name="NAME" value="Temp"/>
            <input name="OUTPUT_VAR_NAME" value="TEMP_FILE_NODE"/>
            <output name="TEMP_FILE_NODE"/>
            <output name="TEMP_FILE_NODE_ID"/>
	    </operation>
	    
	    <sequence name="Compute Similarity" startEvent="running">
	    
	        <operation name="Prepare Inputs" processor="org.janelia.it.jacs.compute.service.entity.SortBySimilarityService">
	            <input name="MODE" value="SETUP"/>
	            <input name="RESULT_FILE_NODE" value="$V{TEMP_FILE_NODE}"/>
	            <input name="TARGET_STACK_ID"/>
	            <input name="FOLDER_ID"/>
	            <output name="TARGET_STACK_FILEPATH"/>
	            <output name="INPUT_LIST_FILEPATH"/>
	            <output name="OUTPUT_LIST_FILEPATH"/>
	        </operation>
	        
	        <sequence name="Compute Similarity" waitForAsync="true">
	            <operation name="Compute Similarity" processor="queue/gridSubmitAndWait">
	                <input name="iservice" value="org.janelia.it.jacs.compute.service.vaa3d.Vaa3DSimilarityService"/>
	                <input name="RESULT_FILE_NODE" value="$V{TEMP_FILE_NODE}"/>
	                <input name="TARGET_STACK_FILEPATH"/>
	                <input name="INPUT_LIST_FILEPATH"/>
	                <input name="OUTPUT_LIST_FILEPATH"/>
	            </operation>
	        </sequence>
	        
    	</sequence>
    	
        <sequence name="Sort Entities" startEvent="postprocess">
	    
	        <operation name="Resort Entities" processor="org.janelia.it.jacs.compute.service.entity.SortBySimilarityService">
	            <input name="MODE" value="RESORT"/>
	            <input name="FOLDER_ID"/>
	            <input name="OUTPUT_LIST_FILEPATH"/>
	        </operation>
    
    	</sequence>
        
        <sequence name="Clean up temporary files" startEvent="postprocess">
            
            <!-- Trash temporary file node -->
            <operation name="Remove Temp Result Nodes" processor="org.janelia.it.jacs.compute.service.entity.TrashFileNodeService">
                <input name="FILE_NODE_ID" value="$V{TEMP_FILE_NODE_ID}"/>
            </operation>
            
    	</sequence>
	    
    </sequence>
</process>