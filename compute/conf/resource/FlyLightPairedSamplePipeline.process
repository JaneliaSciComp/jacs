<process name="FlyLight Paired Sample Pipeline" processor="queue/samplePipelineLauncher" startEvent="pending">
    <!--
         Variant of FlyLightPolarityPipeline.process with more generic names
         that uses v2 configured pair aligner for 63x.
      -->
    <sequence>

        <input name="PIPELINE_PROCESS"/>
        <input name="20X_MERGE_ALGORITHMS" value="$V{20X_MERGE_ALGORITHMS}"/>
        <input name="20X_ALIGNMENT_ALGORITHMS" value="$V{20X_ALIGNMENT_ALGORITHMS}"/>
        <input name="20X_ALIGNMENT_ALGORITHM_PARAMS" value="$V{20X_ALIGNMENT_ALGORITHM_PARAMS}"/>
        <input name="20X_ALIGNMENT_ALGORITHM_RESULT_NAMES" value="$V{20X_ALIGNMENT_ALGORITHM_RESULT_NAMES}"/>
        <input name="20X_ANALYSIS_ALGORITHMS" value="$V{20X_ANALYSIS_ALGORITHMS}"/>
        <input name="63X_MERGE_ALGORITHMS" value="$V{63X_MERGE_ALGORITHMS}"/>
        <input name="63X_ALIGNMENT_ALGORITHMS" value="$V{63X_ALIGNMENT_ALGORITHMS}"/>
        <input name="63X_ALIGNMENT_ALGORITHM_PARAMS" value="$V{63X_ALIGNMENT_ALGORITHM_PARAMS}"/>
        <input name="63X_ALIGNMENT_ALGORITHM_RESULT_NAMES" value="$V{63X_ALIGNMENT_ALGORITHM_RESULT_NAMES}"/>
        <input name="63X_ANALYSIS_ALGORITHMS" value="$V{63X_ANALYSIS_ALGORITHMS}"/>
        <input name="CHANNEL_DYE_SPEC_20X"/>
        <input name="OUTPUT_CHANNEL_ORDER_20X"/>
        <input name="CHANNEL_DYE_SPEC_63X"/>
        <input name="OUTPUT_CHANNEL_ORDER_63X"/>
        
        <!-- Import variables from the task -->
        <operation name="Import Variables" processor="org.janelia.it.jacs.compute.service.common.InitVariablesFromTaskService">
            <input name="OVERRIDE" value="false"/>
            <input name="TASK_PARAMETER_1" value="sample entity id"/>
            <input name="PROCESS_VARIABLE_1" value="SAMPLE_ENTITY_ID"/>
            <input name="TASK_PARAMETER_2" value="reuse pipeline runs"/>
            <input name="PROCESS_VARIABLE_2" value="REUSE_PIPELINE_RUNS"/>
            <input name="TASK_PARAMETER_3" value="reuse processing"/>
            <input name="PROCESS_VARIABLE_3" value="REUSE_PROCESSING"/>
            <input name="TASK_PARAMETER_4" value="reuse alignment"/>
            <input name="PROCESS_VARIABLE_4" value="REUSE_ALIGNMENT"/>
            <output name="SAMPLE_ENTITY_ID"/>
            <output name="REUSE_PIPELINE_RUNS"/>
            <output name="REUSE_PROCESSING"/>
            <output name="REUSE_ALIGNMENT"/>
        </operation>
        
        <!-- Init variables -->
        <operation name="Init Variables" processor="org.janelia.it.jacs.compute.service.common.InitVariablesService">
            <input name="REUSE_ALIGNMENT"/>
            <input name="20X_MERGE_ALGORITHMS"/>
            <input name="20X_ALIGNMENT_ALGORITHMS"/>
            <input name="20X_ALIGNMENT_ALGORITHM_PARAMS"/>
            <input name="20X_ALIGNMENT_ALGORITHM_RESULT_NAMES"/>
            <input name="20X_ANALYSIS_ALGORITHMS"/>
            <input name="63X_MERGE_ALGORITHMS"/>
            <input name="63X_ALIGNMENT_ALGORITHMS"/>
            <input name="63X_ALIGNMENT_ALGORITHM_PARAMS"/>
            <input name="63X_ALIGNMENT_ALGORITHM_RESULT_NAMES"/>
            <input name="63X_ANALYSIS_ALGORITHMS"/>
            <input name="OVERRIDE" value="false"/>

            <input name="PROCESS_VARIABLE_1" value="REUSE_ALIGNMENT"/>
            <input name="PROCESS_VARIABLE_VALUE_1" value="true"/>

            <input name="PROCESS_VARIABLE_2" value="20X_MERGE_ALGORITHMS"/>
            <input name="PROCESS_VARIABLE_VALUE_2" value="FLYLIGHT_ORDERED"/>

            <input name="PROCESS_VARIABLE_3" value="20X_ALIGNMENT_ALGORITHMS"/>
            <input name="PROCESS_VARIABLE_VALUE_3" value="CONFIGURED,CONFIGURED_BRAIN_VNC"/>

            <input name="PROCESS_VARIABLE_4" value="20X_ALIGNMENT_ALGORITHM_PARAMS"/>
            <input name="PROCESS_VARIABLE_VALUE_4" value="flyalign20x_JBA_Qiscore.sh,brainalignPolarity20xBrainVNCRescale_dpx.sh"/>

            <input name="PROCESS_VARIABLE_5" value="20X_ALIGNMENT_ALGORITHM_RESULT_NAMES"/>
            <input name="PROCESS_VARIABLE_VALUE_5" value="JBA Alignment,Brain/VNC Alignment"/>

            <input name="PROCESS_VARIABLE_6" value="20X_ANALYSIS_ALGORITHMS"/>
            <input name="PROCESS_VARIABLE_VALUE_6" value="NEURON_SEPARATOR"/>

            <input name="PROCESS_VARIABLE_7" value="63X_MERGE_ALGORITHMS"/>
            <input name="PROCESS_VARIABLE_VALUE_7" value="FLYLIGHT_ORDERED"/>

            <input name="PROCESS_VARIABLE_8" value="63X_ALIGNMENT_ALGORITHMS"/>
            <input name="PROCESS_VARIABLE_VALUE_8" value="CONFIGURED_PAIR"/>

            <input name="PROCESS_VARIABLE_9" value="63X_ALIGNMENT_ALGORITHM_PARAMS"/>
            <input name="PROCESS_VARIABLE_VALUE_9" value="brainalignPolarityPair_ds_dpx_1024px_INT_v2.sh"/>

            <input name="PROCESS_VARIABLE_10" value="63X_ALIGNMENT_ALGORITHM_RESULT_NAMES"/>
            <input name="PROCESS_VARIABLE_VALUE_10" value="Brain 20X/63X Alignment"/>

            <input name="PROCESS_VARIABLE_11" value="63X_ANALYSIS_ALGORITHMS"/>
            <input name="PROCESS_VARIABLE_VALUE_11" value="NEURON_SEPARATOR"/>

            <output name="REUSE_ALIGNMENT"/>
            <output name="20X_MERGE_ALGORITHMS"/>
            <output name="20X_ALIGNMENT_ALGORITHMS"/>
            <output name="20X_ALIGNMENT_ALGORITHM_PARAMS"/>
            <output name="20X_ALIGNMENT_ALGORITHM_RESULT_NAMES"/>
            <output name="20X_ANALYSIS_ALGORITHMS"/>
            <output name="63X_MERGE_ALGORITHMS"/>
            <output name="63X_ALIGNMENT_ALGORITHMS"/>
            <output name="63X_ALIGNMENT_ALGORITHM_PARAMS"/>
            <output name="63X_ALIGNMENT_ALGORITHM_RESULT_NAMES"/>
            <output name="63X_ANALYSIS_ALGORITHMS"/>
        </operation>

        <!-- Get sub-samples -->
        <operation name="Get Sub-Samples" processor="org.janelia.it.jacs.compute.service.entity.sample.GetObjectiveSamplesService">
            <input name="SAMPLE_ENTITY_ID"/>
            <input name="REUSE_PIPELINE_RUNS"/>
            <output name="PARENT_SAMPLE_ID"/>
            <output name="SAMPLE_20X_ID"/>
            <output name="SAMPLE_63X_ID"/>
        </operation>

        <sequence if="SAMPLE_20X_ID is not null">

            <include name="20x Pipeline" process="FlyLightSamplePipeline">
                <input name="SAMPLE_ENTITY_ID" value="$V{SAMPLE_20X_ID}"/>
                <input name="PIPELINE_NAME" value="Paired Sample Pipeline 20x"/>
                <input name="MERGE_ALGORITHMS" value="$V{20X_MERGE_ALGORITHMS}"/>
                <input name="STITCH_ALGORITHMS" value=""/>
                <input name="ALIGNMENT_ALGORITHMS" value="$V{20X_ALIGNMENT_ALGORITHMS}"/>
                <input name="ALIGNMENT_ALGORITHM_PARAMS" value="$V{20X_ALIGNMENT_ALGORITHM_PARAMS}"/>
                <input name="ALIGNMENT_ALGORITHM_RESULT_NAMES" value="$V{20X_ALIGNMENT_ALGORITHM_RESULT_NAMES}"/>
                <input name="ANALYSIS_ALGORITHMS" value="$V{20X_ANALYSIS_ALGORITHMS}"/>
                <input name="CHANNEL_DYE_SPEC" value="$V{CHANNEL_DYE_SPEC_20X}"/>
                <input name="OUTPUT_CHANNEL_ORDER" value="$V{OUTPUT_CHANNEL_ORDER_20X}"/>
                <input name="PIPELINE_PROCESS"/>
                <input name="REUSE_PROCESSING"/>
                <input name="REUSE_ALIGNMENT"/>
            </include>
        
        </sequence>

        <sequence if="SAMPLE_63X_ID is not null">
            
            <include name="63x Pipeline" process="FlyLightSamplePipeline">
                <input name="SAMPLE_ENTITY_ID" value="$V{SAMPLE_63X_ID}"/>
                <input name="PIPELINE_NAME" value="Paired Sample Pipeline 63x"/>
                <input name="STITCH_ALGORITHMS" value="FLYLIGHT"/>
                <input name="MERGE_ALGORITHMS" value="$V{63X_MERGE_ALGORITHMS}"/>
                <input name="ALIGNMENT_ALGORITHMS" value="$V{63X_ALIGNMENT_ALGORITHMS}"/>
                <input name="ALIGNMENT_ALGORITHM_PARAMS" value="$V{63X_ALIGNMENT_ALGORITHM_PARAMS}"/>
                <input name="ALIGNMENT_ALGORITHM_RESULT_NAMES" value="$V{63X_ALIGNMENT_ALGORITHM_RESULT_NAMES}"/>
                <input name="ANALYSIS_ALGORITHMS" value="$V{63X_ANALYSIS_ALGORITHMS}"/>
                <input name="CHANNEL_DYE_SPEC" value="$V{CHANNEL_DYE_SPEC_63X}"/>
                <input name="OUTPUT_CHANNEL_ORDER" value="$V{OUTPUT_CHANNEL_ORDER_63X}"/>
                <input name="PIPELINE_PROCESS"/>
                <input name="REUSE_PROCESSING"/>
                <input name="REUSE_ALIGNMENT"/>
            </include>
            
        </sequence>
        
    </sequence>
</process>