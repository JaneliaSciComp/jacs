<!-- 
    Discover samples in SAGE, add them into the database and run the configured pipeline for each one.
-->
<process name="User Data Set Pipelines" processor="queue/largePipelineLauncher" startEvent="pending" updateProcessStatus="on_success">
    <sequence>

        <input name="RUN_MODE"/>
        <input name="REUSE_PIPELINE_RUNS"/>
        <input name="REUSE_SUMMARY"/>
        <input name="REUSE_PROCESSING"/>
        <input name="REUSE_ALIGNMENT"/>
        <input name="DATA_SET_NAME"/>
        <input name="RUN_SAMPLE_DISCOVERY"/>

        <!-- Import variables from the task -->
        <operation name="Import Variables" processor="org.janelia.it.jacs.compute.service.common.InitVariablesFromTaskService">
            <input name="OVERRIDE" value="false"/>
            <input name="RUN_MODE"/>
            <input name="REUSE_PIPELINE_RUNS"/>
            <input name="REUSE_SUMMARY"/>
            <input name="REUSE_PROCESSING"/>
            <input name="REUSE_ALIGNMENT"/>
            <input name="DATA_SET_NAME"/>
            <input name="RUN_SAMPLE_DISCOVERY"/>
            <input name="TASK_PARAMETER_MAP">
                <entry key="run mode" value="RUN_MODE"/>
                <entry key="reuse pipeline runs" value="REUSE_PIPELINE_RUNS"/>
                <entry key="reuse summary" value="REUSE_SUMMARY"/>
                <entry key="reuse processing" value="REUSE_PROCESSING"/>
                <entry key="reuse alignment" value="REUSE_ALIGNMENT"/>
                <entry key="data set name" value="DATA_SET_NAME"/>
                <entry key="run sample discovery" value="RUN_SAMPLE_DISCOVERY"/>
            </input>
            <output name="RUN_MODE"/>
            <output name="REUSE_PIPELINE_RUNS"/>
            <output name="REUSE_SUMMARY"/>
            <output name="REUSE_PROCESSING"/>
            <output name="REUSE_ALIGNMENT"/>
            <output name="DATA_SET_NAME"/>
            <output name="RUN_SAMPLE_DISCOVERY"/>
        </operation>

        <!-- By default, reuse whatever is possible to reuse -->
        <operation name="Init Variables" processor="org.janelia.it.jacs.compute.service.common.InitVariablesService">
            <input name="OVERRIDE" value="false"/>
            <input name="REUSE_PIPELINE_RUNS"/>
            <input name="REUSE_SUMMARY"/>
            <input name="REUSE_PROCESSING"/>
            <input name="REUSE_ALIGNMENT"/>
            <input name="RUN_SAMPLE_DISCOVERY"/>
            <input name="PROCESS_VARIABLE_MAP">
                <entry key="REUSE_PIPELINE_RUNS" value="false"/>
                <entry key="REUSE_SUMMARY" value="true"/>
                <entry key="REUSE_PROCESSING" value="true"/>
                <entry key="REUSE_ALIGNMENT" value="true"/>
                <entry key="RUN_SAMPLE_DISCOVERY" value="true"/>
            </input>
            <output name="REUSE_PIPELINE_RUNS"/>
            <output name="REUSE_SUMMARY"/>
            <output name="REUSE_PROCESSING"/>
            <output name="REUSE_ALIGNMENT"/>
            <output name="RUN_SAMPLE_DISCOVERY"/>
        </operation>

        <sequence if="RUN_SAMPLE_DISCOVERY=true">
                        
            <!-- Discover samples in Sage and load them into the database as Entities -->
            <operation name="Initial Image Discovery" processor="org.janelia.it.jacs.compute.service.fileDiscovery.SageDataSetDiscoveryService">
                <input name="DEFAULT_CHANNEL_SPECIFICATION" value="sssr"/>
                <input name="DATA_SET_NAME"/>
            </operation>
                
        </sequence>

        <!-- Find all the Sample Entities in the database -->
        <operation name="Sample Traversal" processor="org.janelia.it.jacs.compute.service.entity.sample.SampleTraversalService">
            <input name="RUN_MODE"/>
            <input name="OUTVAR_ENTITY_ID" value="SAMPLE_ENTITY_ID"/>
            <input name="DATA_SET_NAME"/>
            <output name="SAMPLE_ENTITY_ID"/>
        </operation>

        <!-- Process each Sample Entity -->
        <sequence forEach="SAMPLE_ENTITY_ID">

            <include name="Process sample" process="GSPS_CompleteSamplePipeline">
                <input name="SAMPLE_ENTITY_ID"/>
                <input name="REUSE_PIPELINE_RUNS"/>
                <input name="REUSE_SUMMARY"/>
                <input name="REUSE_PROCESSING"/>
                <input name="REUSE_ALIGNMENT"/>
            </include>

        </sequence>

    </sequence>
</process>
