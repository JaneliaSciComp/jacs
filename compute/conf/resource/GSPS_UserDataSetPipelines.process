<!-- 
	Discover samples in SAGE, add them into the database and run the configured pipeline for each one.
-->
<process name="User Data Set Pipelines" processor="queue/largePipelineLauncher" startEvent="pending" updateProcessStatus="on_success">
	<sequence>
	
        <input name="RUN_MODE"/>
        <input name="REUSE_PIPELINE_RUNS"/>
        <input name="REUSE_PROCESSING"/>
        <input name="REUSE_ALIGNMENT"/>
        <input name="DATA_SET_NAME"/>
        <input name="RUN_SAMPLE_DISCOVERY"/>
        
	    <!-- Import variables from the task -->
	    <operation name="Import Variables" processor="org.janelia.it.jacs.compute.service.common.InitVariablesFromTaskService">
            <input name="OVERRIDE" value="false"/>
	        <input name="TASK_PARAMETER_1" value="run mode"/>
            <input name="PROCESS_VARIABLE_1" value="RUN_MODE"/>
            <input name="TASK_PARAMETER_2" value="reuse pipeline runs"/>
            <input name="PROCESS_VARIABLE_2" value="REUSE_PIPELINE_RUNS"/>
            <input name="TASK_PARAMETER_3" value="reuse processing"/>
            <input name="PROCESS_VARIABLE_3" value="REUSE_PROCESSING"/>
            <input name="TASK_PARAMETER_4" value="reuse alignment"/>
            <input name="PROCESS_VARIABLE_4" value="REUSE_ALIGNMENT"/>
            <input name="TASK_PARAMETER_5" value="data set name"/>
            <input name="PROCESS_VARIABLE_5" value="DATA_SET_NAME"/>
            <input name="TASK_PARAMETER_6" value="run sample discovery"/>
            <input name="PROCESS_VARIABLE_6" value="RUN_SAMPLE_DISCOVERY"/>
	        <output name="RUN_MODE"/>
            <output name="REUSE_PIPELINE_RUNS"/>
	        <output name="REUSE_PROCESSING"/>
            <output name="REUSE_ALIGNMENT"/>
            <output name="DATA_SET_NAME"/>
            <output name="RUN_SAMPLE_DISCOVERY"/>
	    </operation>
	    
        <!-- By default, reuse whatever is possible to reuse -->
        <operation name="Init Variables" processor="org.janelia.it.jacs.compute.service.common.InitVariablesService">
            <input name="OVERRIDE" value="false"/>
            <input name="REUSE_PIPELINE_RUNS"/>
            <input name="REUSE_PROCESSING"/>
            <input name="REUSE_ALIGNMENT"/>
            <input name="RUN_SAMPLE_DISCOVERY"/>
            <input name="PROCESS_VARIABLE_1" value="REUSE_PIPELINE_RUNS"/>
            <input name="PROCESS_VARIABLE_VALUE_1" value="true"/>
            <input name="PROCESS_VARIABLE_2" value="REUSE_PROCESSING"/>
            <input name="PROCESS_VARIABLE_VALUE_2" value="true"/>
            <input name="PROCESS_VARIABLE_3" value="REUSE_ALIGNMENT"/>
            <input name="PROCESS_VARIABLE_VALUE_3" value="true"/>
            <input name="PROCESS_VARIABLE_4" value="RUN_SAMPLE_DISCOVERY"/>
            <input name="PROCESS_VARIABLE_VALUE_4" value="true"/>
            <output name="REUSE_PIPELINE_RUNS"/>
            <output name="REUSE_PROCESSING"/>
            <output name="REUSE_ALIGNMENT"/>
            <output name="RUN_SAMPLE_DISCOVERY"/>
        </operation>
	    
        <sequence if="RUN_SAMPLE_DISCOVERY=true">
                
    	    <!-- Discover samples in Sage and load them into the database as Entities -->
    		<operation name="Initial Image Discovery" processor="org.janelia.it.jacs.compute.service.fileDiscovery.SageDataSetDiscoveryService">
    	        <input name="DEFAULT_CHANNEL_SPECIFICATION" value="sssr"/>
                <input name="DATA_SET_NAME"/>
    		</operation>
                
        </sequence>
		
	    <!-- Find all the Sample Entities in the database -->
		<operation name="Sample Traversal" processor="org.janelia.it.jacs.compute.service.entity.sample.SampleTraversalService">
			<input name="RUN_MODE"/>
			<input name="OUTVAR_ENTITY_ID" value="SAMPLE_ENTITY_ID"/>
            <input name="DATA_SET_NAME"/>
			<output name="SAMPLE_ENTITY_ID"/>
		</operation>
		
	    <!-- Process each Sample Entity -->
        <sequence forEach="SAMPLE_ENTITY_ID">
        
            <include name="Process sample" process="GSPS_CompleteSamplePipeline">
                <input name="SAMPLE_ENTITY_ID"/>
                <input name="REUSE_PIPELINE_RUNS"/>
                <input name="REUSE_PROCESSING"/>
                <input name="REUSE_ALIGNMENT"/>
            </include>
	        
	    </sequence>

    </sequence>
</process>