<!--

	This pipeline will search the neuron fragments collection and look for any neuron separations without existing weights.
    For separations that don't have weights, it kicks off an analysis of the ConsolidatedLabel file and counts the pixel weights for each
    labeled fragment.

    It stores this information in a file that gets added to the neuron fragment model.
	The twist is that two kinds of artifacts will be generated:
-->

<process name="NeuronFragmentWeights" processor="queue/neuronWeightsPipelineLauncher" startEvent="pending" updateProcessStatus="on_success">
	<sequence>
	    <sequence>
    	    <operation name="Create Neuron Weights Result File Node" processor="org.janelia.it.jacs.compute.service.neuronSeparator.NeuronFragmentWeightsService">
                <input name="MODE" value="NODECREATION"/>
                <output name="RESULT_FILE_NODE_ID"/>
                <output name="RESULT_FILE_NODE_DIR" />
            </operation>

	    	<operation name="Initial Neuron Separation Analysis" processor="org.janelia.it.jacs.compute.service.neuronSeparator.NeuronFragmentWeightsService" startEvent="running">
	    	    <input name="MODE" value="SEPARATIONLIST"/>
    			<output name="NEURON_SEPARATION_BATCH_LIST"/>
    		</operation>

	        <!-- Generate the neuron separation weights -->
	        <sequence name="Fragment Pixel Weight Generation" waitForAsync="true">
        		<operation name="Fragment Pixel Weight Generation" processor="queue/gridSubmitAndWait">
        		    <input name="iservice" value="org.janelia.it.jacs.compute.service.neuronSeparator.NeuronFragmentsWeightGridTask"/>
        		    <input name="NEURON_SEPARATION_BATCH_LIST"/>
        		    <input name="RESULT_FILE_NODE_ID"/>
        		    <input name="RESULT_FILE_NODE_DIR"/>
                </operation>
        	</sequence>

            <!-- process the neuron weights into the DB -->
            <sequence name="Processing of neuron separation weights into Model" startEvent="running">
                <operation name="Updating Neuron Separations and Fragments" processor="org.janelia.it.jacs.compute.service.neuronSeparator.NeuronFragmentWeightsService" startEvent="running">
                    <input name="MODE" value="PROCESSRESULTS"/>
        		    <input name="RESULT_FILE_NODE_DIR"/>
                </operation>
        
            </sequence>

     	</sequence>
    </sequence>
</process>