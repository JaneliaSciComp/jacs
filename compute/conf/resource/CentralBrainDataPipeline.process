<!-- 
	Create new central brain samples from whole brain samples, and run the MCFOSamplePipeline for each one 
-->
<process name="Central Brain Data Pipeline" processor="queue/mcfoDataPipelineLauncher" startEvent="pending">
	<sequence>
	
	    <!-- Import variables from the MCFODataPipelineTask -->
	    <operation name="Import Variables" processor="org.janelia.it.jacs.compute.service.common.InitVariablesFromTaskService">
            <input name="TASK_PARAMETER_1" value="top level folder name"/>
            <input name="PROCESS_VARIABLE_1" value="ROOT_ENTITY_NAME"/>
            <input name="TASK_PARAMETER_2" value="refresh processing"/>
            <input name="PROCESS_VARIABLE_2" value="REFRESH_PROCESSING"/>
            <input name="TASK_PARAMETER_3" value="refresh alignment"/>
            <input name="PROCESS_VARIABLE_3" value="REFRESH_ALIGNMENT"/>
            <input name="TASK_PARAMETER_4" value="refresh separation"/>
            <input name="PROCESS_VARIABLE_4" value="REFRESH_SEPARATION"/>
	        <output name="ROOT_ENTITY_NAME"/>
	        <output name="REFRESH_PROCESSING"/>
	        <output name="REFRESH_ALIGNMENT"/>
	        <output name="REFRESH_SEPARATION"/>
	    </operation>
	    
	    <!-- Remake whole brains as central brains -->
		<operation name="Whole Brain Conversion" processor="org.janelia.it.jacs.compute.service.entity.WholeToCentralBrainConversionService">
			<input name="ROOT_ENTITY_NAME"/>
			<input name="OUTVAR_ENTITY_ID" value="SAMPLE_ENTITY_ID"/>
		</operation>
		
	    <!-- Process each Sample Entity -->
        <sequence forEach="SAMPLE_ENTITY_ID">
            <sequence>
				<!-- Spawn a new task to process the Sample	-->
		        <operation name="Process Sample Subtask" processor="org.janelia.it.jacs.compute.service.common.SubTaskExecutionService">
        			<input name="TASK_CLASS" value="org.janelia.it.jacs.model.tasks.fileDiscovery.MCFOSamplePipelineTask"/>
        			<input name="WAIT_FOR_COMPLETION" value="false"/>
		            <input name="PROCESS_DEF_NAME" value="MCFOSamplePipeline"/>
		            <input name="PARAMETER_1_KEY" value="sample entity id"/>
		            <input name="SAMPLE_ENTITY_ID"/>
		            <input name="PARAMETER_1_VALUE" value="$V{SAMPLE_ENTITY_ID}"/>
		            <input name="PARAMETER_2_KEY" value="refresh processing"/>
		            <input name="REFRESH_PROCESSING"/>
		            <input name="PARAMETER_2_VALUE" value="$V{REFRESH_PROCESSING}"/>
		            <input name="PARAMETER_3_KEY" value="refresh alignment"/>
		            <input name="REFRESH_ALIGNMENT"/>
		            <input name="PARAMETER_3_VALUE" value="$V{REFRESH_ALIGNMENT}"/>
		            <input name="PARAMETER_4_KEY" value="refresh separation"/>
		            <input name="REFRESH_SEPARATION"/>
		            <input name="PARAMETER_4_VALUE" value="$V{REFRESH_SEPARATION}"/>
		        </operation>
			</sequence>
	    </sequence>
	    
    </sequence>
</process>