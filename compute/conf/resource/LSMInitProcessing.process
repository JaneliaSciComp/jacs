<!--
    Run all of the pipelines associated with all of the Data Sets that the given Sample is a part of.
-->
<process name="LSM Processing Pipeline" processor="queue/lsmPipelineLauncher" startEvent="pending" updateProcessStatus="on_success">
    <sequence>
        <input name="LSM_NAMES"/>
        <input name="REUSE_PIPELINE_RUNS"/>
        <input name="REUSE_SUMMARY"/>
        <input name="REUSE_PROCESSING"/>
        <input name="REUSE_POST"/>
        <input name="REUSE_ALIGNMENT"/>
        <input name="RUN_OBJECTIVES"/>

        <!-- Import variables from the task -->
        <operation name="Import Variables" processor="org.janelia.it.jacs.compute.service.common.InitVariablesFromTaskService">
            <input name="LSM_NAMES"/>
            <input name="REUSE_PIPELINE_RUNS"/>
            <input name="REUSE_SUMMARY"/>
            <input name="REUSE_PROCESSING"/>
            <input name="REUSE_POST"/>
            <input name="REUSE_ALIGNMENT"/>
            <input name="RUN_OBJECTIVES"/>
            <input name="TASK_PARAMETER_MAP">
                <entry key="lsm names" value="LSM_NAMES"/>
                <entry key="reuse pipeline runs" value="REUSE_PIPELINE_RUNS"/>
                <entry key="reuse summary" value="REUSE_SUMMARY"/>
                <entry key="reuse processing" value="REUSE_PROCESSING"/>
                <entry key="reuse post" value="REUSE_POST"/>
                <entry key="reuse alignment" value="REUSE_ALIGNMENT"/>
                <entry key="run objectives" value="RUN_OBJECTIVES"/>
            </input>
            <output name="LSM_NAMES"/>
            <output name="REUSE_PIPELINE_RUNS"/>
            <output name="REUSE_SUMMARY"/>
            <output name="REUSE_PROCESSING"/>
            <output name="REUSE_POST"/>
            <output name="REUSE_ALIGNMENT"/>
            <output name="RUN_OBJECTIVES"/>
            <output name="TASK_OWNER"/>
        </operation>

        <!-- Get the list of data sets which the sample is a part of -->
        <operation name="Get LSM Sample IDs" processor="org.janelia.it.jacs.compute.service.entity.sample.LSMSampleInitService">
            <input name="TASK_OWNER"/>
            <input name="LSM_NAMES"/>
            <output name="SAMPLE_DATASET_ID_WITH_ENTITY_ID"/>
            <output name="SAGE_TASK"/>
        </operation>

        <sequence forEach="SAGE_TASK">
            <include name="Load sample" process="SageLoader">
                <input name="SAGE_TASK" />
            </include>
        </sequence>

        <sequence forEach="SAMPLE_DATASET_ID_WITH_ENTITY_ID">

            <operation name="Get LSM Sample IDs" processor="org.janelia.it.jacs.compute.service.entity.sample.LSMSampleStartProcessingService">
                <input name="SAMPLE_DATASET_ID_WITH_ENTITY_ID"/>
                <input name="REUSE_PIPELINE_RUNS"/>
                <input name="REUSE_SUMMARY"/>
                <input name="REUSE_PROCESSING"/>
                <input name="REUSE_POST"/>
                <input name="REUSE_ALIGNMENT"/>
                <input name="RUN_OBJECTIVES"/>
            </operation>

        </sequence>

    </sequence>
</process>
