<!-- 
	Asynchronously move the Sample's file node to the archive. 
-->
<process name="Synchronize sample to archive" processor="queue/gridArchiveAccess" startEvent="pending" updateProcessStatus="on_success">
    <sequence>
	
	    <input name="SAMPLE_ENTITY_ID"/>
	
	    <!-- Import variables from the task -->
	    <operation name="Import Variables" processor="org.janelia.it.jacs.compute.service.common.InitVariablesFromTaskService">
    	    <input name="OVERRIDE" value="false"/>
            <input name="SAMPLE_ENTITY_ID"/>
            <input name="TASK_PARAMETER_1" value="sample entity id"/>
            <input name="PROCESS_VARIABLE_1" value="SAMPLE_ENTITY_ID"/>
	        <output name="SAMPLE_ENTITY_ID"/>
	    </operation>
	    
        <!-- Get list of file paths to archive -->
        <operation name="Get list of paths to archive" processor="org.janelia.it.jacs.compute.service.entity.sample.SampleArchiveService">
            <input name="MODE" value="CREATE_ARCHIVE_LIST"/>
            <input name="SAMPLE_ENTITY_ID"/>
            <output name="ORIGINAL_FILE_PATHS"/>
            <output name="RUN_ARCHIVAL"/>
        </operation>
    
        <sequence if="RUN_ARCHIVAL=true">
    
            <!-- Create a result node -->
            <operation name="Create Temp Result Node" processor="org.janelia.it.jacs.compute.service.entity.CreateNamedResultFileNodeService">
                <input name="NAME" value="Temp"/>
                <input name="OUTPUT_VAR_NAME" value="RESULT_FILE_NODE"/>
                <output name="RESULT_FILE_NODE"/>
                <output name="RESULT_FILE_NODE_ID"/>
            </operation>
            
            <!-- Copy the files to archive -->
            <sequence name="Wait Async" waitForAsync="true">
                <operation name="Copy LSMs" processor="queue/gridSubmitAndWait">
                    <input name="iservice" value="org.janelia.it.jacs.compute.service.utility.ArchiveGridService"/>
                    <input name="RESULT_FILE_NODE"/>
                    <input name="SOURCE_FILE_PATHS" value="$V{ORIGINAL_FILE_PATHS}"/>
                    <input name="DELETE_SOURCE_FILES" value="true"/>
                    <output name="INPUT_FILE_PATHS"/>
                    <output name="OUTPUT_FILE_PATHS"/>
                </operation>
            </sequence>
            
            <!-- We're done with the node -->
            <operation name="Remove Temp Result Node" processor="org.janelia.it.jacs.compute.service.entity.TrashFileNodeService">
                <input name="FILE_NODE_ID" value="$V{RESULT_FILE_NODE_ID}"/>
            </operation>
        
            <!-- Update the nodes and entities -->
            <operation name="Update Nodes and Entites" processor="org.janelia.it.jacs.compute.service.utility.UpdateFileNodeService">
                <input name="INPUT_FILE_PATHS"/>
                <input name="OUTPUT_FILE_PATHS"/>
            </operation>
            
        </sequence>
    
    </sequence>
</process>