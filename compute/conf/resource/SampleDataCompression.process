<!-- 
	Compress existing image files to one or more output formats.
-->
<process name="Sample Data Compression" processor="queue/largePipelineLauncher" startEvent="pending" updateProcessStatus="on_success">
	<sequence>
	
		<input name="SAMPLE_ENTITY_ID"/>
        <input name="INPUT_TYPE"/>
	    <input name="OUTPUT_TYPE"/>
        <input name="DELETE_INPUTS"/>
        <input name="EXCLUDE_FILES"/>
	
        <!-- Import variables from the task -->
        <operation name="Import Variables" processor="org.janelia.it.jacs.compute.service.common.InitVariablesFromTaskService">
            <input name="OVERRIDE" value="false"/>
            <input name="SAMPLE_ENTITY_ID"/>
            <input name="OUTPUT_TYPE"/>
            <input name="INPUT_TYPE"/>
            <input name="EXCLUDE_FILES"/>
            <input name="TASK_PARAMETER_MAP">
                <entry key="sample entity id" value="SAMPLE_ENTITY_ID"/>
                <entry key="output type" value="OUTPUT_TYPE"/>
                <entry key="input type" value="INPUT_TYPE"/>
                <entry key="exclude files" value="EXCLUDE_FILES"/>
            </input>
            <output name="SAMPLE_ENTITY_ID"/>
            <output name="OUTPUT_TYPE"/>
            <output name="INPUT_TYPE"/>
            <output name="EXCLUDE_FILES"/>
        </operation>
        
        <!-- Init variables with default values if they have not yet been initialized -->
        <operation name="Init Variables" processor="org.janelia.it.jacs.compute.service.common.InitVariablesService">
            <input name="OVERRIDE" value="false"/>
            <input name="INPUT_TYPE"/>
            <input name="OUTPUT_TYPE"/>
            <input name="DELETE_INPUTS"/>
            <input name="PROCESS_VARIABLE_MAP">
                <entry key="INPUT_TYPE" value="v3draw"/>
                <entry key="OUTPUT_TYPE" value="v3dpbd"/>
                <entry key="DELETE_INPUTS" value="true"/>
            </input>
            <output name="INPUT_TYPE"/>
            <output name="OUTPUT_TYPE"/>
            <output name="DELETE_INPUTS"/>
        </operation>
        
	    <!-- Create the input file list -->
		<operation name="MCFO Data Compress" processor="org.janelia.it.jacs.compute.service.entity.SampleDataCompressionService">
	        <input name="MODE" value="CREATE_INPUT_LIST"/>
			<input name="SAMPLE_ENTITY_ID"/>
            <input name="INPUT_TYPE"/>
            <input name="OUTPUT_TYPE"/>
            <input name="EXCLUDE_FILES"/>
            <input name="DELETE_INPUTS"/>
			<output name="INPUT_PATH_LIST"/>
		</operation>
			    
	    <!-- Create a temp result node -->
	    <operation name="Create Temp Result Node" processor="org.janelia.it.jacs.compute.service.entity.CreateNamedResultFileNodeService">
		    <input name="NAME" value="Temp"/>
	        <output name="RESULT_FILE_NODE"/>
	        <output name="RESULT_FILE_NODE_ID"/>
	    </operation>
	    
	    <!-- Create the output file list -->
		<operation name="MCFO Data Compress" processor="org.janelia.it.jacs.compute.service.entity.SampleDataCompressionService">
	        <input name="MODE" value="CREATE_OUTPUT_LIST"/>
			<input name="SAMPLE_ENTITY_ID"/>
        	<input name="INPUT_TYPE"/>
            <input name="OUTPUT_TYPE"/>
			<input name="INPUT_PATH_LIST"/>
			<output name="OUTPUT_PATH_LIST"/>
		</operation>
	    
	    <!-- Convert all the files in the group -->
        <sequence name="RAW Conversion to PBD" waitForAsync="true">
	        <operation name="RAW Conversion to PBD" processor="queue/gridSubmitAndWait">
	            <input name="iservice" value="org.janelia.it.jacs.compute.service.vaa3d.Vaa3DConversionService"/>
			    <input name="IGNORE_ERRORS" value="true"/>
	    		<input name="RESULT_FILE_NODE"/>
			    <input name="INPUT_PATH_LIST"/>
			    <input name="OUTPUT_PATH_LIST"/>
		    </operation>
		</sequence>
	
	    <!--  Update the affected entities -->
		<operation name="MCFO Data Compress" processor="org.janelia.it.jacs.compute.service.entity.SampleDataCompressionService">
            <input name="MODE" value="COMPLETE"/>
			<input name="SAMPLE_ENTITY_ID"/>
        	<input name="INPUT_TYPE"/>
            <input name="OUTPUT_TYPE"/>
            <input name="INPUT_PATH_LIST"/>
			<input name="OUTPUT_PATH_LIST"/>
            <input name="DELETE_INPUTS"/>
		</operation>
	
	    <!-- Trash temporary file node -->
	    <operation name="Remove Temp Result Nodes" processor="org.janelia.it.jacs.compute.service.entity.TrashFileNodeService">
	        <input name="FILE_NODE_ID" value="$V{RESULT_FILE_NODE_ID}"/>
	    </operation>
		    
    </sequence>
</process>