<!-- 
	Compress existing v3draw files to v3dpbd to save space.
-->
<process name="Sample Data Compression" processor="queue/largePipelineLauncher" startEvent="pending" updateProcessStatus="on_success">
	<sequence>
	
		<input name="ROOT_ENTITY_ID"/>
	
	    <!-- Import variables from the task -->
	    <operation name="Import Variables" processor="org.janelia.it.jacs.compute.service.common.InitVariablesFromTaskService">
            <input name="OVERRIDE" value="false"/>
            <input name="ROOT_ENTITY_ID"/>
            <input name="TASK_PARAMETER_1" value="root entity id"/>
            <input name="PROCESS_VARIABLE_1" value="ROOT_ENTITY_ID"/>
	        <output name="ROOT_ENTITY_ID"/>
	    </operation>
	    
	    <!-- Create the input file list -->
		<operation name="MCFO Data Compress" processor="org.janelia.it.jacs.compute.service.entity.SampleDataCompressionService">
			<input name="ROOT_ENTITY_ID"/>
	        <input name="MODE" value="CREATE_INPUT_LIST"/>
			<output name="INPUT_PATH_LIST"/>
			<output name="ENTITY_MAP"/>
		</operation>
		
	    <sequence forEach="INPUT_PATH_LIST">
        
		    <!-- Create the output file list -->
			<operation name="MCFO Data Compress" processor="org.janelia.it.jacs.compute.service.entity.SampleDataCompressionService">
		        <input name="MODE" value="CREATE_OUTPUT_LIST"/>
				<input name="INPUT_PATH_LIST"/>
				<output name="OUTPUT_PATH_LIST"/>
			</operation>

		    <!-- Create a result node for this group -->
		    <operation name="Create Group Result Nodes" processor="org.janelia.it.jacs.compute.service.entity.CreateNamedResultFileNodeService">
			    <input name="NAME" value="Temp"/>
		        <output name="RESULT_FILE_NODE"/>
		        <output name="RESULT_FILE_NODE_ID"/>
		    </operation>
		    
		    <!-- Convert all the files in the group -->
            <sequence name="RAW Conversion to PBD" waitForAsync="true">
		        <operation name="RAW Conversion to PBD" processor="queue/gridSubmitAndWait">
		            <input name="iservice" value="org.janelia.it.jacs.compute.service.vaa3d.Vaa3DConversionService"/>
				    <input name="IGNORE_ERRORS" value="true"/>
		    		<input name="RESULT_FILE_NODE"/>
				    <input name="INPUT_PATH_LIST"/>
				    <input name="OUTPUT_PATH_LIST"/>
			    </operation>
			</sequence>
		
		    <!--  Update the affected entities -->
			<operation name="MCFO Data Compress" processor="org.janelia.it.jacs.compute.service.entity.SampleDataCompressionService">
                <input name="MODE" value="COMPLETE"/>
                <input name="INPUT_PATH_LIST"/>
				<input name="OUTPUT_PATH_LIST"/>
				<input name="ENTITY_MAP"/>
			</operation>
		
		    <!-- Trash temporary file node -->
		    <operation name="Remove Temp Result Nodes" processor="org.janelia.it.jacs.compute.service.entity.TrashFileNodeService">
		        <input name="FILE_NODE_ID" value="$V{RESULT_FILE_NODE_ID}"/>
		    </operation>
		
		</sequence>        
		    
    </sequence>
</process>