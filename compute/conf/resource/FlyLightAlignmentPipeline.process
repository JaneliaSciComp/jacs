 <!-- 
      Run a brain alignment algorithm on a given input file for a given sample. 
 -->
 <process name="FlyLight Alignment Pipeline" processor="queue/alignmentPipelineLauncher" startEvent="pending" updateProcessStatus="on_success">
	<sequence>

		<input name="PIPELINE_RUN_ENTITY_ID"/>
		<input name="SAMPLE_ENTITY_ID"/>
        <input name="PARAMETERIZED_ALIGNMENT_ALGORITHM"/>
		<input name="SAMPLE_AREAS"/>
        <input name="RUN_ALIGNMENT"/>
        <input name="RUN_ANALYSIS"/>
        <input name="ANALYSIS_ALGORITHM"/>
        <input name="REUSE_ALIGNMENT"/>
        
        <sequence if="REUSE_ALIGNMENT=true">
            
            <!-- Reuse sample processing from previous pipeline run -->
            <operation name="Reuse Alignment Entity" processor="org.janelia.it.jacs.compute.service.entity.sample.ReuseAlignmentResultService">
                <input name="SAMPLE_ENTITY_ID"/>
                <input name="PIPELINE_RUN_ENTITY_ID"/>
                <input name="PARAMETERIZED_ALIGNMENT_ALGORITHM"/>
                <output name="RESULT_ENTITY"/>
                <output name="RESULT_ENTITY_ID"/>
                <output name="ALIGNED_FILENAME"/>
                <output name="RUN_ALIGNMENT"/>
            </operation>
            
            <sequence if="RUN_ALIGNMENT=false">
        
                <!-- Register images -->
                <operation name="Register images" processor="org.janelia.it.jacs.compute.service.entity.sample.ResultImageRegistrationService">
                    <input name="RESULT_ENTITY_ID"/>
                    <input name="DEFAULT_IMAGE_FILENAME" value="$V{ALIGNED_FILENAME}"/>
                    <input name="PIPELINE_RUN_ENTITY_ID"/>
                </operation>
        
            </sequence>
            
        </sequence>
        
        <sequence if="RUN_ALIGNMENT=true">
        
    	    <!-- Create a alignment result node, with nested result nodes for all the pipeline steps -->
    	    <operation name="Create Alignment Result Nodes" processor="org.janelia.it.jacs.compute.service.entity.CreateAlignmentResultFileNodeService">
    	        <output name="RESULT_FILE_NODE"/>
    	        <output name="RESULT_FILE_NODE_ID"/>
    	        <output name="ALIGN_RESULT_FILE_NODE"/>
    	    </operation>
                    
    	    <!-- Read from the Entity model and export the data into parameters that will be used by the subsequent services -->
    	    <operation name="Init Alignment Parameters" processor="org.janelia.it.jacs.compute.service.entity.InitAlignmentParametersService">
    			<input name="PARAMETERIZED_ALIGNMENT_ALGORITHM"/>
    			<output name="ALIGNMENT_SERVICE_CLASS"/>
    			<output name="ALIGNMENT_SCRIPT_NAME"/>
    			<output name="ALIGNMENT_RESULT_NAME"/>
    		</operation>
    		
            <!-- Read from the Entity model and export the data into parameters that will be used by the subsequent services -->
            <operation name="Get Alignment Parameters" processor="org.janelia.it.jacs.compute.service.entity.GetAlignmentInputsService">
                <input name="iservice" value="$V{ALIGNMENT_SERVICE_CLASS}"/>
                <input name="RESULT_FILE_NODE" value="$V{ALIGN_RESULT_FILE_NODE}"/>
                <input name="SAMPLE_ENTITY_ID"/>
                <input name="SAMPLE_AREAS"/>
                <input name="WARP_NEURONS" value="true"/>
                <output name="ALIGNMENT_INPUTS"/>
                <output name="COPY_FROM_ARCHIVE"/>
                <output name="SOURCE_FILE_PATHS"/>
                <output name="TARGET_FILE_PATHS"/>
                <output name="ALIGNED_AREAS"/>
                <output name="RUN_ALIGNER"/>
                <output name="REGENERATE_INPUT"/>
            </operation>
            
            <sequence if="RUN_ALIGNER=true">
	        
	            <sequence if="COPY_FROM_ARCHIVE=true">
	            
	                <!-- Copy the files from archive -->
	                <include name="Archive Grid Copy" process="ArchiveGridCopy">
	                    <input name="SOURCE_FILE_PATHS"/>
	                    <input name="TARGET_FILE_PATHS"/>
	                </include>
	                    
	            </sequence>
	                    
                <sequence forEach="REGENERATE_INPUT">
        
                    <operation name="Get Input Properties" processor="org.janelia.it.jacs.compute.service.common.InitVariablesFromBeanService">
                        <input name="BEAN" value="$V{REGENERATE_INPUT}"/>
                        <input name="BEAN_PROPERTY_1" value="sampleId"/>
                        <input name="PROCESS_VARIABLE_1" value="REGENERATE_SAMPLE_ID"/>
                        <output name="REGENERATE_SAMPLE_ID"/>
                    </operation>
                
                    <operation name="Get Pipeline Process Name" processor="org.janelia.it.jacs.compute.service.entity.sample.GetPipelineForSampleService">
                        <input name="SAMPLE_ENTITY_ID" value="$V{REGENERATE_SAMPLE_ID}"/>
                        <output name="PROCESS_DEF_NAME"/>
                    </operation>
                    
                    <!-- Spawn a new task to process the Sample -->
                    <operation name="Process Sample Subtask" processor="org.janelia.it.jacs.compute.service.common.SubTaskExecutionService">
                        <input name="PROCESS_DEF_NAME"/>
                        <input name="DISPLAY_NAME" value="Input Sample Regeneration"/>
                        <input name="PARAMETER_1_KEY" value="sample entity id"/>
                        <input name="PARAMETER_1_VALUE" value="$V{REGENERATE_SAMPLE_ID}"/>
                        <input name="PROCESS_DATA_MAP">
                            <entry key="QUEUE_OVERRIDE" value="queue/sampleSecondaryPipelineLauncher"/>
                        </input>
                        <input name="TASK_PARAMETER_MAP">
                            <entry key="alignment algorithms" value=""/>
                            <entry key="alignment algorithm parameters" value=""/>
                            <entry key="alignment algorithm result names" value=""/>
                            <entry key="analysis algorithms" value=""/>
                            <entry key="reuse summary" value="false"/>
                            <entry key="reuse processing" value="false"/>
                            <entry key="reuse post" value="false"/>
                            <entry key="reuse alignment" value="false"/>
                            <entry key="persist" value="false"/>
                        </input>
                        <input name="WAIT_FOR_COMPLETION" value="true"/>
                        <input name="EXCEPTION_ON_ERROR" value="true"/>
                        <output name="SUBTASK_ID"/>
                    </operation>
                    
                    <operation name="Update aligned input to use the regenerated file" processor="org.janelia.it.jacs.compute.service.entity.sample.InjectRegeneratedInputService">
                        <input name="TASK_ID" value="$V{SUBTASK_ID}"/>
                        <input name="ALIGNMENT_INPUT" value="$V{REGENERATE_INPUT}"/>
                    </operation>
                
                </sequence>
                    
	       	    <!-- Align the sample -->
	            <sequence name="Align" waitForAsync="true">
	    	        <operation name="Align" processor="queue/gridSubmitAndWait">
	    	            <input name="iservice" value="$V{ALIGNMENT_SERVICE_CLASS}"/>
	    	    		<input name="RESULT_FILE_NODE" value="$V{ALIGN_RESULT_FILE_NODE}"/>
	    	    		<input name="ALIGNMENT_SCRIPT_NAME"/>
	    	    		<input name="ALIGNMENT_INPUTS"/>
	    	    		<input name="SAMPLE_ENTITY_ID"/>
	               		<input name="ALIGNED_AREAS"/>
	    				<output name="ALIGNED_FILENAME"/>
	    				<output name="ALIGNED_IMAGES"/>
	    	        </operation>
	            </sequence>
	        
                <sequence forEach="REGENERATE_INPUT">
                
                    <operation name="Remove regenerate input" processor="org.janelia.it.jacs.compute.service.entity.sample.CleanUpRegeneratedFilesService">
                        <input name="ALIGNMENT_INPUT" value="$V{REGENERATE_INPUT}"/>
                    </operation>
                    
                </sequence>
                
                <!-- Alternative MIP generation methods are disabled for the time being. 
                     See FlyLightSamplePipeline for details.
                
                <operation name="Get Tile List" processor="org.janelia.it.jacs.compute.service.entity.sample.GetInputImagesService">
                    <input name="IMAGE_STACKS" value="$V{ALIGNED_IMAGES}"/>
                    <output name="INPUT_IMAGES"/>
                </operation>
                
                <sequence name="Create Tile Summary Artifacts" waitForAsync="true">
                    <operation name="Create Tile Summary Artifacts" processor="queue/gridSubmitAndWait">
                        <input name="iservice" value="org.janelia.it.jacs.compute.service.image.BasicMIPandMovieGenerationService"/>
                        <input name="RESULT_FILE_NODE" value="$V{ALIGN_RESULT_FILE_NODE}"/>
                        <input name="OUTPUT_FILE_NODE" value="$V{ALIGN_RESULT_FILE_NODE}"/>
                        <input name="INPUT_IMAGES"/>
                        <input name="NORMALIZE_TO_FIRST_IMAGE" value="false"/>
                        <input name="OUTPUTS" value="mips:movies"/>
                    </operation>
                </sequence>
	            
	            -->
	            
	    	    <!-- Generate MIP for the stitched file -->
	            <sequence name="Generate sample MIPs" waitForAsync="true">
	    	        <operation name="Generate MIPs" processor="queue/gridSubmitAndWait">
	    	            <input name="iservice" value="org.janelia.it.jacs.compute.service.neuronSeparator.MIPGenerationService"/>
	    				<input name="RESULT_FILE_NODE" value="$V{ALIGN_RESULT_FILE_NODE}"/>
	    				<input name="INPUT_IMAGES" value="$V{ALIGNED_IMAGES}"/>
	    	        </operation>
	            </sequence>
	            
	            <!-- Load the alignment results into the database -->
	            <operation name="Discover Alignment Results" processor="org.janelia.it.jacs.compute.service.fileDiscovery.AlignmentResultsDiscoveryService">
	                <input name="ROOT_FILE_NODE" value="$V{ALIGN_RESULT_FILE_NODE}"/>
	                <input name="ROOT_ENTITY_ID" value="$V{PIPELINE_RUN_ENTITY_ID}"/>
	                <input name="RESULT_ENTITY_NAME" value="$V{ALIGNMENT_RESULT_NAME}"/>
	                <output name="RESULT_ENTITY_ID"/>
	                <output name="PREWARPED_SEPARATION"/>
	            </operation>
	            
	    	    <!-- Register images -->
	    		<operation name="Register images" processor="org.janelia.it.jacs.compute.service.entity.sample.ResultImageRegistrationService">
	    			<input name="RESULT_ENTITY_ID"/>
	    			<input name="DEFAULT_IMAGE_FILENAME" value="$V{ALIGNED_FILENAME}"/>
	                <input name="PIPELINE_RUN_ENTITY_ID"/>
	    	    </operation>
	    	    
	            <!-- Synchronize results to SAGE -->
	            <operation name="Sage Qi Score Sync" processor="org.janelia.it.jacs.compute.service.entity.SageQiScoreSyncService">
	                <input name="ALIGNMENT_ID" value="$V{RESULT_ENTITY_ID}"/>
	            </operation>
	    
	            <sequence if="RUN_ANALYSIS=true">
	                <sequence forEach="ANALYSIS_ALGORITHM">
	                        
	                    <!-- Get the aligned image ids -->
	                    <operation name="Get Aligned Images" processor="org.janelia.it.jacs.compute.service.entity.sample.GetAlignedImagesService">
	                        <input name="RESULT_ENTITY_ID"/>
	                        <output name="IMAGE_ID"/>
	                    </operation>
	                    
	                    <!-- Run separation for each alignment output (e.g. 20x, 63x, etc...) -->
	                    <sequence forEach="IMAGE_ID">
	                            
	                        <!-- Get aligned image attributes -->
	                        <operation name="Get Parameters" processor="org.janelia.it.jacs.compute.service.entity.sample.InitAlignedImagePropertiesService">
	                            <input name="IMAGE_ID"/>
	                            <output name="FILENAME"/>
	                            <output name="OPTICAL_RESOLUTION"/>
	                            <output name="PIXEL_RESOLUTION"/>
	                            <output name="OBJECTIVE"/>
			    				<output name="SIGNAL_CHANNELS"/>
			    				<output name="REFERENCE_CHANNEL"/>
	                            <output name="ALIGNED_CONSOLIDATED_LABEL_FILEPATH"/>
	                        </operation>
	                        
	    	    			<sequence if="SIGNAL_CHANNELS is not empty">
		                        
		                        <!-- Run neuron separation if there are signal channels to analyze -->
		                        <include process="FlyLightSeparationPipeline" name="Aligned neuron separation" startEvent="running">
		                            <input name="ROOT_ENTITY_ID" value="$V{RESULT_ENTITY_ID}"/>
		                            <input name="SAMPLE_ENTITY_ID"/>
		                            <input name="INPUT_IMAGE_ID" value="$V{IMAGE_ID}"/>
		                            <input name="INPUT_FILENAME" value="$V{FILENAME}"/>
		                            <input name="RESULT_ENTITY_NAME" value="Aligned Neuron Separation"/>
		                            <input name="SIGNAL_CHANNELS"/>
		                            <input name="REFERENCE_CHANNEL"/>
		                            <input name="OPTICAL_RESOLUTION"/>
		                            <input name="PIXEL_RESOLUTION"/>
		                            <input name="OBJECTIVE"/>
		                            <input name="ALIGNED_CONSOLIDATED_LABEL_FILEPATH"/>
		                        </include>
		                        
	                        </sequence>
	                    
	                    </sequence>
	                    
	                </sequence>
	            </sequence>
	    
	        </sequence>
	        
        </sequence>
    
    </sequence>
    
</process>