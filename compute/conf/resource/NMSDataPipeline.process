<!-- 
	Discover LSM pairs in the fileshare and add them to a data set, and then run them.
-->
<process name="NMS Data Pipeline" processor="queue/consolePipelineLauncher" startEvent="pending" updateProcessStatus="on_success">
	<sequence>
	
	    <operation name="Import Variables" processor="org.janelia.it.jacs.compute.service.common.InitVariablesFromTaskService">
            <input name="TASK_PARAMETER_1" value="list of input directories"/>
            <input name="PROCESS_VARIABLE_1" value="INPUT_DIR_LIST"/>
            <input name="TASK_PARAMETER_2" value="top level folder name"/>
            <input name="PROCESS_VARIABLE_2" value="ROOT_ENTITY_NAME"/>
            <input name="TASK_PARAMETER_3" value="data set identifier"/>
            <input name="PROCESS_VARIABLE_3" value="DATA_SET_IDENTIFIER"/>
	        <input name="TASK_PARAMETER_4" value="run mode"/>
            <input name="PROCESS_VARIABLE_4" value="RUN_MODE"/>
	        <output name="INPUT_DIR_LIST"/>
	        <output name="ROOT_ENTITY_NAME"/>
	        <output name="DATA_SET_IDENTIFIER"/>
	        <output name="RUN_MODE"/>
	    </operation>
	    
	    <!-- Discover samples in the fileshare and load them into the database as Entities -->
		<operation name="Initial File Discovery" processor="org.janelia.it.jacs.compute.service.fileDiscovery.OrderedLSMPairDiscoveryService">
			<input name="INPUT_DIR_LIST"/>
			<input name="ROOT_ENTITY_NAME"/>
			<input name="CHANNEL_SPECIFICATION" value="sssr"/>
			<input name="DATA_SET_IDENTIFIER"/>
		</operation>
	    
	    <!-- Find all the Sample Entities in the database -->
		<operation name="Sample Traversal" processor="org.janelia.it.jacs.compute.service.entity.sample.SampleTraversalService">
			<input name="RUN_MODE"/>
			<input name="OUTVAR_ENTITY_ID" value="SAMPLE_ENTITY_ID"/>
			<output name="SAMPLE_ENTITY_ID"/>
		</operation>
		
	    <!-- Process each Sample Entity -->
        <sequence forEach="SAMPLE_ENTITY_ID">
				
			<!-- Spawn a new task to process the Sample	-->
	        <operation name="Process Sample Subtask" processor="org.janelia.it.jacs.compute.service.common.SubTaskExecutionService">
	            <input name="PROCESS_DEF_NAME" value="GSPS_CompleteSamplePipeline"/>
	            <input name="PARAMETER_1_KEY" value="sample entity id"/>
	            <input name="PARAMETER_1_VALUE" value="$V{SAMPLE_ENTITY_ID}"/>
	        </operation>
	        
	    </sequence>
	    
    </sequence>
</process>