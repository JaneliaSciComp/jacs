<!-- 
	Process a batch of neuron separation results and ensure they have all the necessary artifacts for a given run mode.
-->
<process name="Repair Separations Batch Pipeline" processor="queue/analysisPipelineLauncher" startEvent="pending" updateProcessStatus="on_success">
	<sequence>
	
        <input name="RUN_MODE"/>
        <input name="ENTITY_LIST"/>
        
        <!-- Import variables from the task -->
        <operation name="Import Variables" processor="org.janelia.it.jacs.compute.service.common.InitVariablesFromTaskService">
            <input name="TASK_PARAMETER_1" value="run mode"/>
            <input name="PROCESS_VARIABLE_1" value="RUN_MODE"/>
            <input name="TASK_PARAMETER_2" value="entity list"/>
            <input name="PROCESS_VARIABLE_2" value="ENTITY_LIST"/>
            <output name="RUN_MODE"/>
            <output name="ENTITY_LIST"/>
        </operation>
	            
	    <!-- Create a result node for this grid run -->
	    <operation name="Create Temp Result Node" processor="org.janelia.it.jacs.compute.service.entity.CreateNamedResultFileNodeService">
		    <input name="NAME" value="Temp"/>
            <input name="OUTPUT_VAR_NAME" value="TEMP_FILE_NODE"/>
            <output name="TEMP_FILE_NODE"/>
            <output name="TEMP_FILE_NODE_ID"/>
	    </operation>
	    
	    <!-- Generate artifacts for all the separations in the list -->
        <sequence name="Generate Artifacts" waitForAsync="true">
		    <operation name="Generate Artifacts" processor="queue/gridSubmitAndWait">
		        <input name="iservice" value="org.janelia.it.jacs.compute.service.neuronSeparator.RepairArtifactsPipelineGridService"/>
				<input name="RESULT_FILE_NODE" value="$V{TEMP_FILE_NODE}"/>
				<input name="RUN_MODE"/>
				<input name="ENTITY_LIST"/>
		    </operation>
        </sequence>
		        
        <!-- Trash temporary file node -->
        <operation name="Remove Temp Result Nodes" processor="org.janelia.it.jacs.compute.service.entity.TrashFileNodeService">
            <input name="FILE_NODE_ID" value="$V{TEMP_FILE_NODE_ID}"/>
        </operation>
        
    </sequence>
</process>