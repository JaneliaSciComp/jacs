<!-- 
	Generate a mapping between two neuron separation results. Newer separation pipeline runs will automatically generate this mapping,
	but this service can be used to back-populate the mappings for older separations.
-->
<process name="Generate mapping between two separations" processor="queue/analysisPipelineLauncher" startEvent="pending" updateProcessStatus="on_success">
    <sequence>
	
	   <input name="SEPARATION_ID_1"/>
	   <input name="SEPARATION_ID_2"/>
	
	    <!-- Import variables from the task -->
	    <operation name="Import Variables" processor="org.janelia.it.jacs.compute.service.common.InitVariablesFromTaskService">
    	    <input name="OVERRIDE" value="false"/>
            <input name="TASK_PARAMETER_1" value="separation id 1"/>
            <input name="PROCESS_VARIABLE_1" value="SEPARATION_ID_1"/>
            <input name="TASK_PARAMETER_2" value="separation id 2"/>
            <input name="PROCESS_VARIABLE_2" value="SEPARATION_ID_2"/>
            <output name="SEPARATION_ID_1"/>
            <output name="SEPARATION_ID_2"/>
	    </operation>
    
        <!-- Create a result node -->
        <operation name="Create Temp Result Node" processor="org.janelia.it.jacs.compute.service.entity.CreateNamedResultFileNodeService">
            <input name="NAME" value="Temp"/>
            <input name="OUTPUT_VAR_NAME" value="RESULT_FILE_NODE"/>
            <output name="RESULT_FILE_NODE"/>
            <output name="RESULT_FILE_NODE_ID"/>
        </operation>

        <!-- Generate the mapping and move it into the new separation -->
        <sequence name="Generate mapping" waitForAsync="true">
            <operation name="Generate mapping" processor="queue/gridSubmitAndWait">
                <input name="iservice" value="org.janelia.it.jacs.compute.service.neuronSeparator.NeuronMappingGridService"/>
                <input name="ARCHIVE_FLAG" value="true"/>
                <input name="RESULT_FILE_NODE"/>
                <input name="SEPARATION_ID_1"/>
                <input name="SEPARATION_ID_2"/>
            </operation>
        </sequence>
        
        <!-- Update the new separation to include the mapping file -->
        <operation name="Discover Neuron Separation Results" processor="org.janelia.it.jacs.compute.service.fileDiscovery.IncrementalSeparationDiscoveryService">
            <input name="SEPARATION_ID" value="$V{SEPARATION_ID_2}"/>
        </operation>
        
    </sequence>
</process>