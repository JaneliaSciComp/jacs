<!--
	Creates 3D Compartment Annotation for a file which lists a set of input files
-->
<process name="Compartment Annotation 3D Process" processor="queue/compartmentAnnotation3DLauncher" startEvent="pending">
   <sequence>

      <operation name="Compartment Annotation 3D" processor="org.janelia.it.jacs.compute.service.annotation.CompartmentAnnotation3DService">
        <input name="MODE" value="SETUP"/>
        <output name="SAMPLE_ID_LIST"/>
        <output name="SAMPLE_NAME_LIST"/>
        <output name="PATTERN_ANNOTATION_PATH"/>
        <output name="ALIGNED_STACK_PATH_LIST"/>
        <output name="RESOURCE_DIR_PATH"/>
        <output name="RESULT_FILE_NODE"/>
        <output name="PATTERN_CHANNEL"/>
        <output name="IMAGE_CONVERSION_RESULT_NODE_MAP"/>
        <output name="MIPS_CONVERSION_PATH"/>
      </operation>

      <sequence name="Compute Pattern Annotation" waitForAsync="true">
        <operation name="Pattern Annotation" processor="queue/gridSubmitAndWait">
            <input name="iservice" value="org.janelia.it.jacs.compute.service.vaa3d.Vaa3DPatternAnnotationService"/>
            <input name="RESULT_FILE_NODE"/>
            <input name="SAMPLE_ID_LIST"/>
            <input name="SAMPLE_NAME_LIST"/>
            <input name="PATTERN_ANNOTATION_PATH"/>
            <input name="ALIGNED_STACK_PATH_LIST"/>
            <input name="RESOURCE_DIR_PATH"/>
            <input name="PATTERN_CHANNEL"/>
        </operation>
      </sequence>

      <sequence forEach="MIPS_CONVERSION_PATH" waitForAsync="true">
        <sequence async="true">
            <sequence name="MIP Conversion to PNG" waitForAsync="true">
                <operation name="MIP Conversion to PNG" processor="queue/gridSubmitAndWait">
                    <input name="iservice" value="org.janelia.it.jacs.compute.service.utility.ImageConversionService"/>
                    <input name="IMAGE_CONVERSION_RESULT_NODE_MAP"/>
                    <input name="MIPS_CONVERSION_PATH"/>
                    <input name="ALTERNATE_WORKING_DIR_PATH" value="$V{MIPS_CONVERSION_PATH}"/>
             		<input name="INPUT_FILENAME_REGEX" value="((.*?)MIP)\.tif$"/>
                    <input name="OUTPUT_FILENAME_PATTERN" value="$1.png"/>
                </operation>
            </sequence>
        </sequence>
      </sequence>

      <operation name="Completion phase of Pattern Annotation Service" processor="org.janelia.it.jacs.compute.service.annotation.CompartmentAnnotation3DService">
        <input name="MODE" value="COMPLETE"/>
        <input name="SAMPLE_ID_LIST"/>
        <input name="SAMPLE_NAME_LIST"/>
        <input name="PATTERN_ANNOTATION_PATH"/>
        <input name="ALIGNED_STACK_PATH_LIST"/>
        <input name="TOP_LEVEL_FOLDER_ID"/>
        <input name="RESULT_FILE_NODE"/>
      </operation>

   </sequence>

</process>
