 <!-- 
      Post-processing of the unaligned stacks of the given sample. 
 -->
 <process name="FlyLight Post-Processing Pipeline" processor="queue/samplePipelineLauncher" startEvent="pending" updateProcessStatus="on_success">
    <sequence>

        <input name="PIPELINE_RUN_ENTITY_ID"/>
        <input name="SAMPLE_ENTITY_ID"/>
        <input name="IMAGE_TYPE"/>
        <input name="OUTPUT_COLOR_SPEC"/>
        <input name="REUSE_POST"/>
    
        <!-- Decide which types of processing will be run -->
        <operation name="Choose Summary Processing Steps" processor="org.janelia.it.jacs.compute.service.entity.sample.ChoosePostProcessingPipelineStepsService">
            <output name="RUN_POST"/>
        </operation>
        
        <sequence if="REUSE_POST=true">
            
            <!-- Reuse sample processing from previous pipeline run -->
            <operation name="Reuse Alignment Entity" processor="org.janelia.it.jacs.compute.service.entity.sample.ReusePostProcessingResultService">
                <input name="SAMPLE_ENTITY_ID"/>
                <input name="PIPELINE_RUN_ENTITY_ID"/>
                <output name="RESULT_ENTITY"/>
                <output name="RESULT_ENTITY_ID"/>
                <output name="RUN_POST"/>
            </operation>
            
            <sequence if="RUN_POST=false">
        
                <!-- Register images -->
                <operation name="Register images" processor="org.janelia.it.jacs.compute.service.entity.sample.ResultImageRegistrationService">
                    <input name="RESULT_ENTITY_ID"/>
                    <input name="PIPELINE_RUN_ENTITY_ID"/>
                </operation>
        
            </sequence>
            
        </sequence>
        
        <sequence if="RUN_POST=true">
        
            <!-- Create a result node for this group -->
            <operation name="Create Post-Processing Result Node" processor="org.janelia.it.jacs.compute.service.entity.CreateNamedResultFileNodeService">
                <input name="NAME" value="Post"/>
                <input name="OUTPUT_VAR_NAME" value="POST_RESULT_FILE_NODE"/>
                <output name="POST_RESULT_FILE_NODE"/>
                <output name="POST_RESULT_FILE_NODE_ID"/>
            </operation>
            
            <!-- Get a list of unaligned images to create summaries for -->
            <operation name="Get unaligned image List" processor="org.janelia.it.jacs.compute.service.entity.sample.GetUnalignedInputImagesService">
                <input name="SAMPLE_ENTITY_ID"/>
                <input name="PIPELINE_RUN_ENTITY_ID"/>
                <input name="MODE" value="$V{IMAGE_TYPE}"/>
                <input name="OUTPUT_COLOR_SPEC"/>
                <output name="INPUT_IMAGES"/>
                <output name="RUN_BASIC"/>
                <output name="NORMALIZE_TO_FIRST_IMAGE"/>
            </operation>
            
            <sequence if="RUN_BASIC=true">
            
                <!-- Create MIPs and movies for all unaligned images -->
                <sequence name="Create Unaligned Image Artifacts" waitForAsync="true">
                    <operation name="Create Unaligned Image Artifacts" processor="queue/gridSubmitAndWait">
                        <input name="iservice" value="org.janelia.it.jacs.compute.service.image.BasicMIPandMovieGenerationService"/>
                        <input name="RESULT_FILE_NODE" value="$V{POST_RESULT_FILE_NODE}"/>
                        <input name="OUTPUT_FILE_NODE" value="$V{POST_RESULT_FILE_NODE}"/>
                        <input name="INPUT_IMAGES"/>
                        <input name="NORMALIZE_TO_FIRST_IMAGE"/>
                        <input name="OUTPUTS" value="mips:movies:legends"/>
                    </operation>
                </sequence>
                
            </sequence>
            
            <sequence if="RUN_BASIC=false">
            
                <!-- Create MIPs and movies for all unaligned images -->
                <sequence name="Create Unaligned Image Artifacts" waitForAsync="true">
                    <operation name="Create Unaligned Image Artifacts" processor="queue/gridSubmitAndWait">
                        <input name="iservice" value="org.janelia.it.jacs.compute.service.image.EnchancedMIPandMovieGenerationService"/>
                        <input name="RESULT_FILE_NODE" value="$V{POST_RESULT_FILE_NODE}"/>
                        <input name="OUTPUT_FILE_NODE" value="$V{POST_RESULT_FILE_NODE}"/>
                        <input name="INPUT_IMAGES"/>
                        <input name="OUTPUTS" value="mips:movies"/>
                        <input name="IMAGE_TYPE"/>
                    </operation>
                </sequence>
                
            </sequence>

            <!-- Create montages from unaligned image MIPs -->
            <sequence name="Create Unaligned Montages" waitForAsync="true">
                <operation name="Create Unaligned Montages" processor="queue/gridSubmitAndWait">
                    <input name="iservice" value="org.janelia.it.jacs.compute.service.utility.MontageService"/>
                    <input name="RESULT_FILE_NODE" value="$V{POST_RESULT_FILE_NODE}"/>
                    <input name="INPUT_FILE_NODE" value="$V{POST_RESULT_FILE_NODE}"/>
                </operation>
            </sequence>
           
            <!-- Load the MIPs and movies into the database -->
            <operation name="Discover Post-Processing Results" processor="org.janelia.it.jacs.compute.service.fileDiscovery.IncrementalSummaryResultsDiscoveryService">
                <input name="ROOT_FILE_NODE" value="$V{POST_RESULT_FILE_NODE}"/>
                <input name="RESULT_ENTITY_ID"/>
                <input name="SAMPLE_ENTITY_ID"/>
            </operation>
                
            <!-- Register images -->
            <operation name="Register images" processor="org.janelia.it.jacs.compute.service.entity.sample.ResultImageRegistrationService">
                <input name="PIPELINE_RUN_ENTITY_ID"/>
                <input name="RESULT_ENTITY_ID"/>
            </operation>
            
        </sequence>
    
    </sequence>
    
</process>