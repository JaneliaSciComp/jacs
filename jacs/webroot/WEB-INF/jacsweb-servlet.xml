<?xml version="1.0" encoding="UTF-8" ?>
<!--
  ~ Copyright (c) 2010-2011, J. Craig Venter Institute, Inc.
  ~
  ~ This file is part of JCVI VICS.
  ~
  ~ JCVI VICS is free software; you can redistribute it and/or modify it
  ~ under the terms and conditions of the Artistic License 2.0.  For
  ~ details, see the full text of the license in the file LICENSE.txt.  No
  ~ other rights are granted.  Any and all third party software rights to
  ~ remain with the original developer.
  ~
  ~ JCVI VICS is distributed in the hope that it will be useful in
  ~ bioinformatics applications, but it is provided "AS IS" and WITHOUT
  ~ ANY EXPRESS OR IMPLIED WARRANTIES including but not limited to
  ~ implied warranties of merchantability or fitness for any particular
  ~ purpose.  For details, see the full text of the license in the file
  ~ LICENSE.txt.
  ~
  ~ You should have received a copy of the Artistic License 2.0 along with
  ~ JCVI VICS.  If not, the license can be obtained from
  ~ "http://www.perlfoundation.org/artistic_license_2_0."
  -->

<!DOCTYPE beans PUBLIC "-//SPRING//DTD BEAN//EN" "http://www.springframework.org/dtd/spring-beans.dtd">

<!-- DispatcherServlet application context for JaCS's web tier. -->
<beans>

    <!-- Bean to pickup properties for subsequent use. -->
    <bean name="placeHolderConfig"
          class="org.springframework.beans.factory.config.PropertyPlaceholderConfigurer">
        <property name="location" value="/WEB-INF/classes/jacs.properties"/>
    </bean>

    <bean id="publicationHelper" class="org.janelia.it.jacs.web.gwt.download.server.DbPublicationHelper">
        <property name="downloadDAO" ref="downloadDAO" />
        <property name="projectBaseLocation" value="${download_delivery_controller.base_file_location}" />
    </bean>

    <bean id="multipartResolver" class="org.springframework.web.multipart.commons.CommonsMultipartResolver"/>

    <!-- Exception Resolver -->
    <bean id="exceptionResolver" class="org.springframework.web.servlet.handler.SimpleMappingExceptionResolver">
        <property name="exceptionMappings">
            <props>
                <!--<prop key="org.springframework.dao.DataAccessException">common/error_500</prop>-->
                <!--<prop key="org.springframework.transaction.TransactionException">common/error_500</prop>-->
                <prop key="org.janelia.it.jacs.web.NotYetImplementedException">common/notYetImplemented</prop>
                <prop key="java.lang.Exception">common/genericError</prop>
            </props>
        </property>
        <property name="exceptionAttribute" value="exceptionBean"/>
    </bean>

    <!-- Bean name View Resolver must be before InternalResourceViewResolever-->
    <bean class="org.springframework.web.servlet.view.BeanNameViewResolver">
    </bean>

    <!-- View Resolver -->
    <bean id="viewResolver" class="org.springframework.web.servlet.view.InternalResourceViewResolver">
        <property name="prefix" value="/WEB-INF/jsp/"/>
        <property name="suffix" value=".jsp"/>
    </bean>

    <bean name="userInterceptor" class="org.janelia.it.jacs.web.control.UserVerificationInterceptor">
        <property name="computeServerBean" ref="remoteComputeOrderService"/>
        <property name="userDAO" ref="userDAO"/>
    </bean>

    <!-- this interceptor will keep all session opened during request opened until
    end of request processing -->
    <bean id="openHibernateSessionInView" class="org.springframework.orm.hibernate3.support.OpenSessionInViewInterceptor">
        <property name="sessionFactory" ref="sessionFactory"/>
        <property name="flushModeName" value="FLUSH_AUTO" />
        <property name="singleSession" value="true" />
    </bean>

    <bean id="urlHandlerMapping" class="org.springframework.web.servlet.handler.SimpleUrlHandlerMapping">
        <property name="order" value="1"/>
        <property name="interceptors">
            <list>
                <ref bean="userInterceptor"/>
                <ref bean="openHibernateSessionInView" />
            </list>
        </property>

        <property name="urlMap">
            <map>
                <entry key="/gwt/**/fileUpload.htm" value-ref="fileUploadController" />
                <entry key="/fileDelivery.htm" value-ref="fileDeliveryController"/>
                <entry key="/downloadEcho.htm" value-ref="downloadEchoController" />
                <entry key="/detailPage.htm" value-ref="detailPageForwardingController" />
                <entry key="/search.htm" value-ref="searchForwardingController"/>
                <entry key="/project.htm" value-ref="projectForwardingController"/>
                <entry key="/disclaimer.htm" value-ref="entryPointsController"/>
                <entry key="/styleTutorial.htm" value-ref="entryPointsController"/>
                <entry key="/gwt/**/*.htm" value-ref="entryPointsController"/>
                <entry key="/admin/blastTaskReport.htm" value-ref="blastTaskReportController"/>
                <entry key="/admin/taskReport.htm" value-ref="taskReportController"/>

                <entry key="/logout.htm" value-ref="logoutController"/>
                <entry key="/**/tiledImage.srv" value-ref="tiledImageService" />
                <entry key="/**/admin.srv" value-ref="adminService"/>
                <entry key="/**/data.srv" value-ref="dataService"/>
                <entry key="/**/blast.srv" value-ref="blastService"/>
                <entry key="/**/recruitment.srv" value-ref="recruitmentService"/>
                <entry key="/**/cref.srv" value-ref="crossReferencingService"/>
                <entry key="/**/status.srv" value-ref="statusService"/>
                <entry key="/**/bsDetail.srv" value-ref="bsDetailService"/>
                <entry key="/**/clDetail.srv" value-ref="clDetailService"/>
                <entry key="/**/preference.srv" value-ref="preferenceService"/>
                <entry key="/**/project.srv" value-ref="projectService"/>
                <entry key="/**/proteinDetail.srv" value-ref="proteinDetailService"/>
                <entry key="/**/export.srv" value-ref="exportService"/>
            </map>
        </property>

    </bean>

    <!-- Entry point controllers -->
    <bean name="entryPointsController" class="org.janelia.it.jacs.web.control.EntryPointController">
        <property name="methodNameResolver">
            <bean class="org.springframework.web.servlet.mvc.multiaction.PropertiesMethodNameResolver">
                <property name="mappings">
                     <props>
                         <prop key="/gwt/Admin/Admin.htm">admin</prop>
                         <prop key="/gwt/AdvancedBlast/AdvancedBlast.htm">advancedblast</prop>
                         <prop key="/gwt/AnalysisPipeline16S/AnalysisPipeline16S.htm">ap16s</prop>
                         <prop key="/gwt/BarcodeDesigner/BarcodeDesigner.htm">barcode</prop>
                         <prop key="/gwt/Blast/Blast.htm">blast</prop>
                         <prop key="/gwt/BrowseProjectsPage/BrowseProjectsPage.*">browseProjects</prop>
                         <prop key="/gwt/ClosurePrimerDesign/ClosurePrimerDesign.htm">cpd</prop>
                         <prop key="/gwt/DegeneratePrimerDesign/DegeneratePrimerDesign.htm">dpd</prop>
                         <prop key="/gwt/DetailPage/DetailPage.htm">detail</prop>
                         <prop key="/disclaimer.htm">disclaimer</prop>
                         <prop key="/gwt/DownloadByPubPage/DownloadByPubPage.*">downloadByPub</prop>
                         <prop key="/gwt/jacs/DownloadNewFilesPage.htm">downloadNewFiles</prop>
                         <prop key="/gwt/DownloadNewFilesPage/DownloadNewFilesPage.htm">downloadNewFiles</prop>
                         <prop key="/gwt/EditProject/EditProject.htm">editProject</prop>
                         <prop key="/gwt/EditPublication/EditPublication.htm">editPublication</prop>
                         <prop key="/gwt/EukAnnot/EukAnnotation.htm">eukAnnotation</prop>
                         <prop key="/gwt/FRData/FRData.htm">frdata</prop>
                         <prop key="/gwt/FRV/Frv.htm">frv</prop>
                         <prop key="/gwt/NeuronalAssayAnalysis/NeuronalAssayAnalysis.htm">neuronalAssayAnalysis</prop>
                         <prop key="/gwt/TIC/TIC.htm">tic</prop>
                         <prop key="/gwt/Header/Header.htm">header</prop>
                         <prop key="/gwt/Home/Home.htm">home</prop>
                         <prop key="/gwt/Inspect/Inspect.htm">inspect</prop>
                         <prop key="/gwt/IntersiteComparisonTool/IntersiteComparisonTool.htm">ict</prop>
                         <prop key="/gwt/MapTest/MapTest.htm">mapTest</prop>
                         <prop key="/gwt/MgAnnot/MgAnnotation.htm">mgAnnotation</prop>
                         <prop key="/gwt/NeuronSeparator/NeuronSeparator.htm">neuronSeparator</prop>
                         <prop key="/gwt/ProfileComparison/ProfileComparison.htm">profileComparison</prop>
                         <prop key="/gwt/ProjectSamplesPage/ProjectSamplesPage.*">projectSamples</prop>
                         <prop key="/gwt/ProkAnnot/ProkAnnotation.htm">prokAnnotation</prop>
                         <prop key="/gwt/PsiBlast/PsiBlast.htm">psiBlast</prop>
                         <prop key="/gwt/ReversePsiBlast/ReversePsiBlast.htm">reversePsiBlast</prop>
                         <prop key="/gwt/RnaSeq/RnaSeq.htm">rnaSeq</prop>
                         <prop key="/gwt/Search/Search.*">search</prop>
                         <prop key="/gwt/Status/Status.htm">status</prop>
                         <prop key="/gwt/ZlaticLab/ZlaticLab.htm">zlaticLab</prop>
                         <prop key="/styleTutorial.htm">styleTutorial</prop>
                         <prop key="/gwt/Test/Test.*">testmethod</prop>
                     </props>
                </property>
            </bean>
        </property>
    </bean>

    <bean name="logoutController" class="org.janelia.it.jacs.web.control.LogoutController"/>

    <bean name="downloadEchoController" class="org.janelia.it.jacs.web.control.download.DownloadEchoController"/>

    <bean name="blastTaskReportController" class="org.janelia.it.jacs.web.control.report.BlastTaskReportController">
        <property name="taskDAO" ref="taskDAO"/>
        <property name="nodeDAO" ref="nodeDAO"/>
    </bean>

    <bean name="taskReportController" class="org.janelia.it.jacs.web.control.report.TaskReportController">
        <property name="taskDAO" ref="taskDAO"/>
        <property name="nodeDAO" ref="nodeDAO"/>
        <property name="computeBean" ref="remoteComputeOrderService"/>
    </bean>

    <bean name="fileUploadController" class="org.janelia.it.jacs.web.control.blast.FileUploadController">
    </bean>

    <bean name="fileDeliveryController" class="org.janelia.it.jacs.web.control.download.FileDeliveryController">
        <property name="fileNodeDAO" ref="fileNodeDAO"/>
        <property name="computeServerBean" ref="remoteComputeOrderService"/>
        <property name="baseFileLocation"  value="${download_delivery_controller.base_file_location}" />
        <property name="ftpHostLocation" value="${download_delivery_controller.ftp_host_port_location}" />
        <!-- Where the things to download will be on disk. -->
        <property name="ftpFileLocation" value="${download_delivery_controller.ftp_disk_location}" />
        <!-- A locational prefix that is convenient for constraints on FTP server. -->
        <property name="ftpLinkTargetLocation" value="${download_delivery_controller.ftp_link_target_location}" />

        <!-- Some files (like blast.zip archives) can be large, live in the filestore, and need ftp support -->
        <property name="filestoreBaseFileLocation"  value="${FileStore.CentralDir}" />
        <property name="filestoreFtpLinkTargetLocation" value="${blast_result_download_delivery_controller.ftp_link_target_location}" />
    </bean>

    <bean name="detailPageForwardingController" class="org.janelia.it.jacs.web.control.DetailPageForwardingController">
        <property name="downloadDAO" ref="downloadDAO"/>
    </bean>

    <bean name="searchForwardingController" class="org.janelia.it.jacs.web.control.search.SearchForwardingController">
        <property name="nodeDAO" ref="nodeDAO"/>
    </bean>

    <bean name="projectForwardingController" class="org.janelia.it.jacs.web.control.ProjectForwardingController">
    </bean>

    <!-- Forwarding controllers for GWT services -->
    <bean id="baseServiceController" class="org.janelia.it.jacs.web.gwt.common.server.JcviGWTSpringController">
        <property name="sessionFactory" ref="sessionFactory"/>
        <property name="taskDao" ref="taskDAO"/>
    </bean>

    <bean name="downloadService"
          class="org.janelia.it.jacs.web.gwt.download.server.DownloadMetaDataServiceImpl"
          parent="baseServiceController">
        <property name="publicationHelper" ref="publicationHelper"/>
    </bean>
    <bean name="downloadEchoService"
          class="org.janelia.it.jacs.web.gwt.common.server.DownloadEchoServiceImpl"
          parent="baseServiceController">
    </bean>
    <bean name="tiledImageService"
          class="org.janelia.it.jacs.web.control.image.TiledImageRetriever">
    </bean>
    <bean name="dataService"
          class="org.janelia.it.jacs.web.gwt.common.server.DataServiceImpl"
          parent="baseServiceController">
        <property name="blastAPI" ref="blastAPI"/>
        <property name="userAPI" ref="userAPI" />
        <property name="dataSetAPI" ref="dataSetAPI"/>
        <property name="nodeDAO" ref="nodeDAO" />
        <property name="fileNodeDAO" ref="fileNodeDAO"/>
        <property name="taskDAO" ref="taskDAO"/>
        <property name="userDAO" ref="userDAO"/>
    </bean>
    <bean name="exportService"
          class="org.janelia.it.jacs.web.gwt.common.server.ExportServiceImpl"
          parent="baseServiceController">
        <property name="exportAPI" ref="exportAPI"/>
    </bean>
    <bean name="recruitmentService"
          class="org.janelia.it.jacs.web.gwt.frv.server.RecruitmentServiceImpl"
          parent="baseServiceController">
        <property name="recruitmentAPI" ref="recruitmentAPI"/>
    </bean>
    <bean name="viewService"
          class="org.janelia.it.jacs.web.gwt.common.server.view.ViewServiceImpl"
          parent="baseServiceController">
    </bean>
    <bean name="logService"
          class="org.janelia.it.jacs.web.gwt.common.server.LoggingServiceImpl"
          parent="baseServiceController">
    </bean>
    <bean name="adminService"
          class="org.janelia.it.jacs.web.gwt.admin.server.AdminServiceImpl"
          parent="baseServiceController">
        <property name="userAPI" ref="userAPI"/>
        <property name="featureAPI" ref="featureAPI"/>
        <property name="dataSetAPI" ref="dataSetAPI"/>
        <property name="userDAO"  ref="userDAO" />
    </bean>
    <bean name="blastService"
          class="org.janelia.it.jacs.web.gwt.blast.server.BlastServiceImpl"
          parent="baseServiceController">
        <property name="blastAPI" ref="blastAPI"/>
        <property name="blastDAO"  ref="blastDAO" />
    </bean>
    <bean name="crossReferencingService"
        class="org.janelia.it.jacs.web.gwt.detail.server.bse.xlink.CRefEntityServiceImpl"
        parent="baseServiceController">
        <property name="featureDAO" ref="featureDAO"/>
    </bean>
    <bean name="statusService"
          class="org.janelia.it.jacs.web.gwt.common.server.StatusServiceImpl"
          parent="baseServiceController">
        <property name="taskDAO" ref="taskDAO"/>
        <property name="nodeDAO" ref="nodeDAO" />
        <property name="fileNodeDAO" ref="fileNodeDAO"/>
        <property name="searchAPI" ref="searchAPI"/>
        <property name="jobControlAPI" ref="jobControlAPI"/>
    </bean>
    <bean name="searchService"
        class="org.janelia.it.jacs.web.gwt.search.server.SearchServiceImpl"
        parent="baseServiceController">
        <property name="searchAPI" ref="searchAPI"/>
    </bean>
    <bean name="sampleDetailService"
        class="org.janelia.it.jacs.web.gwt.detail.server.sample.SampleServiceImpl"
        parent="baseServiceController">
        <property name="featureDAO" ref="featureDAO"/>
    </bean>
    <bean name="bsDetailService"
          class="org.janelia.it.jacs.web.gwt.detail.server.bse.BSEntityServiceImpl"
          parent="baseServiceController">
        <property name="metadataDAO" ref="metadataDAO" />
        <property name="featureDAO" ref="featureDAO" />
    </bean>
    <bean name="clDetailService"
          class="org.janelia.it.jacs.web.gwt.detail.server.cluster.ClusterDetailServiceImpl"
          parent="baseServiceController">
        <property name="featureAPI" ref="featureAPI" />
    </bean>
    <bean name="proteinDetailService"
          class="org.janelia.it.jacs.web.gwt.detail.server.bse.peptide.ProteinDetailServiceImpl"
          parent="baseServiceController">
        <property name="featureDAO" ref="featureDAO" />
    </bean>
    <bean name="preferenceService"
          class="org.janelia.it.jacs.web.gwt.common.server.prefs.PreferenceServiceImpl"
          parent="baseServiceController">
        <property name="preferenceDAO"  ref="preferenceDAO" />
    </bean>
    <bean name="projectService"
          class="org.janelia.it.jacs.web.gwt.admin.editproject.server.ProjectServiceImpl"
          parent="baseServiceController" >
        <property name="downloadDAO"  ref="downloadDAO" />
    </bean>


    <!-- ========================= SPECIFIC VIEW DEFINITIONS FOR  ========================= -->
    <!-- ========================= DEFINITION FOR NON-SECURED CONTROLLERS========================= -->
    <bean name="openAccessUserInterceptor" class="org.janelia.it.jacs.web.control.OpenAccessUserVerificationInterceptor">
        <property name="computeServerBean" ref="remoteComputeOrderService"/>
        <property name="userDAO" ref="userDAO"/>
    </bean>

    <bean id="nonSecureHandlerMapping" class="org.springframework.web.servlet.handler.SimpleUrlHandlerMapping">
        <property name="order" value="2"/>
        <property name="interceptors">
            <list>
                <ref bean="openAccessUserInterceptor"/>
                <ref bean="openHibernateSessionInView" />
            </list>
        </property>
        <property name="urlMap">
            <map>
                <entry key="/healthMonitor.chk" value-ref="healthMonitorController" />
                <entry key="/id" value-ref="detailPageForwardingController"/>
                <entry key="/search.oa" value-ref="searchForwardingController"/>
                <entry key="/gwt/**/Search.oa" value-ref="entryPointsController"/>
                <entry key="/gwt/**/BrowseProjectsPage.oa" value-ref="entryPointsController"/>
                <entry key="/gwt/**/DownloadByPubPage.oa" value-ref="entryPointsController"/>
                <entry key="/gwt/**/ProjectSamplesPage.oa" value-ref="entryPointsController"/>
                <entry key="/gwt/**/Test.oa" value-ref="entryPointsController"/>

                <entry key="/**/download.oas" value-ref="downloadService"/>
                <entry key="/**/downloadEcho.oas" value-ref="downloadEchoService" />
                <entry key="/**/search.oas" value-ref="searchService"/>
                <entry key="/**/sampledetail.oas" value-ref="sampleDetailService"/>
                <entry key="/**/log.oas" value-ref="logService"/>
            </map>
        </property>
    </bean>
    <bean name="healthMonitorController" class="org.janelia.it.jacs.web.control.HealthCheckController" >
        <property name="ejbProxy" ref="remoteAppVersionGetter" />
        <property name="userDAO" ref="userDAO"/>
        <property name="appVersion" value="${jacs.version}"/>
    </bean>
</beans>
