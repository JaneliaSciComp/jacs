<?xml version="1.0"?>
<project name="jacsweb" default="build">
    <!-- Import all the generic module targets from buildprocess module -->
    <import file="../buildprocess/build-module.xml"/>
    <property file="${basedir}/../buildprocess/config/${user.name}.properties" />

    <!-- jaxb stuff -->
    <property name="schema.home" value="${basedir}/../shared/schema"/>
    <property name="jaxb.src.dir" value="${basedir}/src"/>

    <target name="set-common-properties" depends="build-module-init.set-common-properties">
        <!-- lib names -->
        <property name="log4j.name" value="log4j-1.2.14.jar" />

        <!-- war stuff -->
        <property name="webapp.name" value="jacs" />
        <property name="jar.name" value="${webapp.name}.jar" />
        <property name="build.war.dir" value="${build.dir}/wars" />
        <property name="webroot.dir" value="${basedir}/webroot" />
        <property name="jsp.dir" value="${webroot.dir}/WEB-INF/jsp" />
        <property name="js.dir" value="${webroot.dir}/js" />
        <property name="css.dir" value="${webroot.dir}/css" />
        <property name="images.dir" value="${webroot.dir}/images" />
        <property name="war.name" value="${webapp.name}.war" />
        <property name="deploy.dir" value="${tomcat.home}/${tomcat.deploy.dir}"/>
        <property name="build.war.unzipped.dir" value="${build.war.dir}/unzipped"/>
        <property name="jaas.plugin.name" value="${webapp.name}-jaasplugin.jar" />
        <property name="jaas.plugin.config.name" value="jaas.config" />

        <!-- GWT Stuff -->
        <property name="gwt.home" value="${basedir}/../common/GWT/" />
        <property name="gwt.build.dir" value="${build.dir}/gwt" />
        <property name="gwt.flavour" value="windows" /> <!-- Use Linux or Windows gwt-dev jar -->
        <property name="gwt.common.dir" value="org/janelia/it/jacs/web/gwt/common" />
        <property name="gwt.common.jar.name" value="${webapp.name}-gwt-common.jar" />
        <property name="gwt.dev.jar.name" value="gwt-dev-${gwt.flavour}.jar"/>
        <property name="gwt.compiler.default" value="@browser-compiler-setting@"/>
        <property name="gwt.test.ui.default" value="@selenium-test-setting@"/>

        <condition property="compilation.threadcount" value="${compilation.threads}" else="3">
            <isset property="compilation.threads"/>
        </condition>

        <condition property="skip.GWT.compilation" value="${skip.GWT.compile}" else="true">
            <isset property="skip.GWT.compile"/>
        </condition>

        <echo message="Compilation threads = ${compilation.threadcount}"/>
        <echo message="Skipping compile = ${skip.GWT.compilation}"/>

        <!-- External dependencies for compilation -->
        <path id="compile.classpath.additional">
            <fileset dir="${model.module}/build/jars" includes="jacs-model.jar" />
            <fileset dir="${shared.module}/build/jars" includes="jacs-shared.jar" />
            <fileset dir="${common.module}/Spring" />
            <!--<fileset dir="${gwt.home}" includes="${gwt.dev.jar.name}" />-->
            <pathelement location="${common.module}/GWT/gwt-maps.jar" />
            <pathelement location="${common.module}/GWT/gwt-user.jar" />
            <pathelement location="${common.module}/GWT/gwt-widgets-0.2.0.jar" />
            <pathelement location="${common.module}/GWT/gwt-sl-1.0.jar" />
            <pathelement location="${common.module}/GWT/gwt-dnd-3.0.1.jar" />
            <pathelement location="${common.module}/GWT/gwt-java-math-1.0.9.jar" />
            <pathelement location="${common.module}/GWT/${gwt.dev.jar.name}" />  <!-- includes apache commons stuff -->

            <pathelement location="${compute.module}/build/jars/compute-client.jar"/>
        </path>

        <!-- GWT compiler classpath -->
        <path id="compile.classpath.gwt">
            <pathelement path="${gwt.build.dir}"/>
            <pathelement path="${src.dir}" />
            <fileset dir="${model.module}/build/jars" includes="jacs-model.jar" />
            <fileset dir="${shared.module}/build/jars" includes="jacs-shared.jar" />
            <fileset dir="lib" includes="*.jar"/>
            <fileset dir="${gwt.home}" includes="**/*.jar" />
            <fileset dir="${build.jars.dir}" includes="${gwt.common.jar.name}"/> <!-- include our "common" gwt module -->
            <pathelement location="${common.module}/GWT/${gwt.dev.jar.name}" />  <!-- includes apache commons stuff -->
        </path>

        <!-- additional classes needed to compile and/or run tests -->
        <path id="test.classpath.additional">
            <pathelement path="${model.module}/build/test/classes"/> <!-- shared test classes -->
            <pathelement path="${src.dir}" />
            <fileset dir="${compute.module}/build/jars/" includes="compute-client.jar"/>
            <fileset dir="${shared.module}/build/jars/" includes="*.jar"/>
            <fileset dir="${shared.module}/testfiles/" includes="**/*.*"/>
            <fileset dir="${model.module}/build/jars/" includes="jacs-model.jar" />
            <pathelement location="${model.module}/build/jars/"/>
            <fileset dir="lib" includes="*.jar"/>
            <fileset dir="${gwt.home}" includes="**/*.jar" />
            <fileset dir="${build.jars.dir}" includes="${gwt.common.jar.name}"/> <!-- include our "common" gwt module -->
            <fileset dir="${common.module}/Hibernate-3.2/" includes="*.jar"/>
            <fileset file="${common.module}/MySQL/mysql-connector-java-5.1.15-bin.jar"/>
            <fileset dir="${common.module}/JAXB-2.1.5/" includes="*.jar"/>
            <fileset dir="${shared.module}/conf/" includes="jacs.properties"/>
            <pathelement location="${common.module}/GWT/${gwt.dev.jar.name}" />  <!-- includes apache commons stuff -->
        </path>
            

    </target>

    <!-- Defines the set of targets that should be run to completely build this module. -->
	<target name="build" depends="setup, war" description="compiles and packages this module"/>


    <!--<target name="jaxb-code-generate" depends="setup">-->
        <!--<xjc schema="${schema.home}/project.xsd" destdir="${jaxb.src.dir}" package="org.janelia.it.jacs.server.ie.jaxb"-->
             <!--classpath="${shared.module}/build/jars/jacs-shared.jar">-->
              <!--<produces dir="${jaxb.src.dir}/org/janelia/it/jacs/server/ie/jaxb" />-->
        <!--</xjc>-->
    <!--</target>-->

    <target name="build-no-GWT" description="compiles and packages this module">
        <antcall target="build">
            <param name="skip.GWT.compilation" value="true"/>
        </antcall>
    </target>

    <!-- Runs the GWT compiler to convert client (browser) Java into JS for all modules -->
    <target name="gwt-compile" depends="setup, make-gwt-build-dir" description="Generate client side content with GWT"
            unless="${skip.GWT.compilation}">
        <parallel threadcount="${compilation.threadcount}">
            <!-- Package up the common code module-->
            <antcall target="gwt-package-common"/>

            <!-- Header module is required for all entry points -->
            <!--todo Test: FRV, Project Sample Page, Detail Page, Status, Search, DownloadNewFilesPage-->
            <antcall target="gwt-compile-module">
                <param name="gwt.module.name" value="org.janelia.it.jacs.web.gwt.header.Header" />
                <param name="gwt.module.descriptor" value="org/janelia/it/jacs/web/gwt/header/Header.gwt.xml" />
            </antcall>

             <!--&lt;!&ndash;Compile the entry point modules &ndash;&gt;-->
            <antcall target="gwt-compile-module">
                <param name="gwt.module.name" value="org.janelia.it.jacs.web.gwt.home.Home" />
                <param name="gwt.module.descriptor" value="org/janelia/it/jacs/web/gwt/home/Home.gwt.xml" />
            </antcall>
            <antcall target="gwt-compile-module">
                <param name="gwt.module.name" value="org.janelia.it.jacs.web.gwt.advancedblast.AdvancedBlast" />
                <param name="gwt.module.descriptor" value="org/janelia/it/jacs/web/gwt/advancedblast/AdvancedBlast.gwt.xml" />
            </antcall>
            <antcall target="gwt-compile-module">
                <param name="gwt.module.name" value="org.janelia.it.jacs.web.gwt.neuronSeparator.NeuronSeparator" />
                <param name="gwt.module.descriptor" value="org/janelia/it/jacs/web/gwt/neuronSeparator/NeuronSeparator.gwt.xml" />
            </antcall>
            <antcall target="gwt-compile-module">
                <param name="gwt.module.name" value="org.janelia.it.jacs.web.gwt.status.Status" />
                <param name="gwt.module.descriptor" value="org/janelia/it/jacs/web/gwt/status/Status.gwt.xml" />
            </antcall>
            <antcall target="gwt-compile-module">
                <param name="gwt.module.name" value="org.janelia.it.jacs.web.gwt.tic.TIC" />
                <param name="gwt.module.descriptor" value="org/janelia/it/jacs/web/gwt/tic/TIC.gwt.xml" />
            </antcall>
            <!--<antcall target="gwt-compile-module">-->
              <!--<param name="gwt.module.name" value="org.janelia.it.jacs.web.gwt.admin.Admin" />-->
              <!--<param name="gwt.module.descriptor" value="org/janelia/it/jacs/web/gwt/admin/Admin.gwt.xml" />-->
            <!--</antcall>-->
            <!--<antcall target="gwt-compile-module">-->
                <!--<param name="gwt.module.name" value="org.janelia.it.jacs.web.gwt.test.CleanGWTEntities" />-->
                <!--<param name="gwt.module.descriptor" value="org/janelia/it/jacs/web/gwt/test/CleanGWTEntities.gwt.xml" />-->
            <!--</antcall>-->

            <!--<antcall target="gwt-compile-module">-->
            <!--<param name="gwt.module.name" value="org.janelia.it.jacs.web.gwt.geci.NeuronalAssayAnalysis" />-->
            <!--<param name="gwt.module.descriptor" value="org/janelia/it/jacs/web/gwt/geci/NeuronalAssayAnalysis.gwt.xml" />-->
            <!--</antcall>-->
            <!--<antcall target="gwt-compile-module">-->
                <!--<param name="gwt.module.name" value="org.janelia.it.jacs.web.gwt.zlatic.ZlaticLab" />-->
                <!--<param name="gwt.module.descriptor" value="org/janelia/it/jacs/web/gwt/zlatic/ZlaticLab.gwt.xml" />-->
            <!--</antcall>-->
            <!--<antcall target="gwt-compile-module">-->
                <!--<param name="gwt.module.name" value="org.janelia.it.jacs.web.gwt.psiBlast.PsiBlast" />-->
                <!--<param name="gwt.module.descriptor" value="org/janelia/it/jacs/web/gwt/psiBlast/PsiBlast.gwt.xml" />-->
            <!--</antcall>-->
            <!--<antcall target="gwt-compile-module">-->
                <!--<param name="gwt.module.name" value="org.janelia.it.jacs.web.gwt.reversePsiBlast.ReversePsiBlast" />-->
                <!--<param name="gwt.module.descriptor" value="org/janelia/it/jacs/web/gwt/reversePsiBlast/ReversePsiBlast.gwt.xml" />-->
            <!--</antcall>-->
            <!--<antcall target="gwt-compile-module">-->
                <!--<param name="gwt.module.name" value="org.janelia.it.jacs.web.gwt.ap16s.AnalysisPipeline16S" />-->
                <!--<param name="gwt.module.descriptor" value="org/janelia/it/jacs/web/gwt/ap16s/AnalysisPipeline16S.gwt.xml" />-->
            <!--</antcall>-->
            <!--<antcall target="gwt-compile-module">-->
                <!--<param name="gwt.module.name" value="org.janelia.it.jacs.web.gwt.barcode.BarCodeDesigner" />-->
                <!--<param name="gwt.module.descriptor" value="org/janelia/it/jacs/web/gwt/barcode/BarCodeDesigner.gwt.xml" />-->
            <!--</antcall>-->
            <!--<antcall target="gwt-compile-module">-->
                <!--<param name="gwt.module.name" value="org.janelia.it.jacs.web.gwt.matrix.ProfileComparison" />-->
                <!--<param name="gwt.module.descriptor" value="org/janelia/it/jacs/web/gwt/matrix/ProfileComparison.gwt.xml" />-->
            <!--</antcall>-->
            <!--<antcall target="gwt-compile-module">-->
                <!--<param name="gwt.module.name" value="org.janelia.it.jacs.web.gwt.prokAnnot.ProkAnnot" />-->
                <!--<param name="gwt.module.descriptor" value="org/janelia/it/jacs/web/gwt/prokAnnot/ProkAnnot.gwt.xml" />-->
            <!--</antcall>-->
            <!--<antcall target="gwt-compile-module">-->
                <!--<param name="gwt.module.name" value="org.janelia.it.jacs.web.gwt.mgAnnot.MgAnnot" />-->
                <!--<param name="gwt.module.descriptor" value="org/janelia/it/jacs/web/gwt/mgAnnot/MgAnnot.gwt.xml" />-->
            <!--</antcall>-->
            <!--<antcall target="gwt-compile-module">-->
                <!--<param name="gwt.module.name" value="org.janelia.it.jacs.web.gwt.download.BrowseProjectsPage" />-->
                <!--<param name="gwt.module.descriptor" value="org/janelia/it/jacs/web/gwt/download/BrowseProjectsPage.gwt.xml" />-->
            <!--</antcall>-->
            <!--<antcall target="gwt-compile-module">-->
                <!--<param name="gwt.module.name" value="org.janelia.it.jacs.web.gwt.download.DownloadByPubPage" />-->
                <!--<param name="gwt.module.descriptor" value="org/janelia/it/jacs/web/gwt/download/DownloadByPubPage.gwt.xml" />-->
            <!--</antcall>-->
            <!--<antcall target="gwt-compile-module">-->
                <!--<param name="gwt.module.name" value="org.janelia.it.jacs.web.gwt.frv.Frv" />-->
                <!--<param name="gwt.module.descriptor" value="org/janelia/it/jacs/web/gwt/frv/Frv.gwt.xml" />-->
            <!--</antcall>-->
            <!--<antcall target="gwt-compile-module">-->
                <!--<param name="gwt.module.name" value="org.janelia.it.jacs.web.gwt.frdata.FRData" />-->
                <!--<param name="gwt.module.descriptor" value="org/janelia/it/jacs/web/gwt/frdata/FRData.gwt.xml" />-->
            <!--</antcall>-->
            <!--<antcall target="gwt-compile-module">-->
                <!--<param name="gwt.module.name" value="org.janelia.it.jacs.web.gwt.inspect.Inspect" />-->
                <!--<param name="gwt.module.descriptor" value="org/janelia/it/jacs/web/gwt/inspect/Inspect.gwt.xml" />-->
            <!--</antcall>-->
            <!--<antcall target="gwt-compile-module">-->
                <!--<param name="gwt.module.name" value="org.janelia.it.jacs.web.gwt.download.ProjectSamplesPage" />-->
                <!--<param name="gwt.module.descriptor" value="org/janelia/it/jacs/web/gwt/download/ProjectSamplesPage.gwt.xml" />-->
            <!--</antcall>-->
            <!--<antcall target="gwt-compile-module">-->
                <!--<param name="gwt.module.name" value="org.janelia.it.jacs.web.gwt.download.DownloadNewFilesPage" />-->
                <!--<param name="gwt.module.descriptor" value="org/janelia/it/jacs/web/gwt/download/DownloadNewFilesPage.gwt.xml" />-->
            <!--</antcall>-->
            <!--<antcall target="gwt-compile-module">-->
                <!--<param name="gwt.module.name" value="org.janelia.it.jacs.web.gwt.detail.DetailPage" />-->
                <!--<param name="gwt.module.descriptor" value="org/janelia/it/jacs/web/gwt/detail/DetailPage.gwt.xml" />-->
            <!--</antcall>-->
            <!--<antcall target="gwt-compile-module">-->
                <!--<param name="gwt.module.name" value="org.janelia.it.jacs.web.gwt.search.Search" />-->
                <!--<param name="gwt.module.descriptor" value="org/janelia/it/jacs/web/gwt/search/Search.gwt.xml" />-->
            <!--</antcall>-->
            <!--<antcall target="gwt-compile-module">-->
                <!--<param name="gwt.module.name" value="org.janelia.it.jacs.web.gwt.rnaSeq.RnaSeq"/>-->
                <!--<param name="gwt.module.descriptor" value="org/janelia/it/jacs/web/gwt/rnaSeq/RnaSeq.gwt.xml"/>-->
            <!--</antcall>-->
        </parallel>

        <!-- Experimental -->
        <!--<antcall target="gwt-compile-module">-->
            <!--<param name="gwt.module.name" value="org.janelia.it.jacs.web.gwt.eukAnnot.EukAnnot" />-->
            <!--<param name="gwt.module.descriptor" value="org/janelia/it/jacs/web/gwt/eukAnnot/EukAnnot.gwt.xml" />-->
        <!--</antcall>-->
        <!--<antcall target="gwt-compile-module">-->
            <!--<param name="gwt.module.name" value="org.janelia.it.jacs.web.gwt.ict.IntersiteComparisonTool" />-->
            <!--<param name="gwt.module.descriptor" value="org/janelia/it/jacs/web/gwt/ict/IntersiteComparisonTool.gwt.xml" />-->
        <!--</antcall>-->
        <!--<antcall target="gwt-compile-module">-->
            <!--<param name="gwt.module.name" value="org.janelia.it.jacs.web.gwt.dpd.DegeneratePrimerDesign" />-->
            <!--<param name="gwt.module.descriptor" value="org/janelia/it/jacs/web/gwt/dpd/DegeneratePrimerDesign.gwt.xml" />-->
        <!--</antcall>-->
        <!--<antcall target="gwt-compile-module">-->
            <!--<param name="gwt.module.name" value="org.janelia.it.jacs.web.gwt.cpd.ClosurePrimerDesign" />-->
            <!--<param name="gwt.module.descriptor" value="org/janelia/it/jacs/web/gwt/cpd/ClosurePrimerDesign.gwt.xml" />-->
        <!--</antcall>-->
        <!--<antcall target="gwt-compile-module">-->
            <!--<param name="gwt.module.name" value="org.janelia.it.jacs.web.gwt.admin.editpublication.EditPublication" />-->
            <!--<param name="gwt.module.descriptor" value="org/janelia/it/jacs/web/gwt/admin/editpublication/EditPublication.gwt.xml" />-->
        <!--</antcall>-->
        <!--<antcall target="gwt-compile-module">-->
            <!--<param name="gwt.module.name" value="org.janelia.it.jacs.web.gwt.admin.editproject.EditProject" />-->
            <!--<param name="gwt.module.descriptor" value="org/janelia/it/jacs/web/gwt/admin/editproject/EditProject.gwt.xml" />-->
        <!--</antcall>-->
        <!--<antcall target="gwt-compile-module">-->
            <!--<param name="gwt.module.name" value="org.janelia.it.jacs.web.gwt.test.Test" />-->
            <!--<param name="gwt.module.descriptor" value="org/janelia/it/jacs/web/gwt/test/Test.gwt.xml" />-->
        <!--</antcall>-->
        <!--<antcall target="gwt-compile-module">-->
            <!--<param name="gwt.module.name" value="org.janelia.it.jacs.web.gwt.map.MapTest" />-->
        <!--</antcall>-->
        <!--Blast Wizard has been removed (hidden) from application it makes no sense building it-->
       <!--<antcall target="gwt-compile-module">-->
           <!--<param name="gwt.module.name" value="org.janelia.it.jacs.web.gwt.blast.Blast" />-->
           <!--<param name="gwt.module.descriptor" value="org/janelia/it/jacs/web/gwt/blast/Blast.gwt.xml" />-->
       <!--</antcall>-->

    </target>

    <!-- TODO: good description of target -->
    <!-- javac and jar the common code module - code and class files -->
    <target name="gwt-package-common" depends="setup, make-classes-dir, make-jars-dir">
        <!-- Aggregate the final classpath -->
        <path id="compile.classpath.final">
            <path refid="compile.classpath.additional"/> <!-- set by the calling module -->
            <path refid="compile.classpath.jaxb" />
            <fileset dir="${lib.dir}" includes="**/*.jar" />
        </path>
        <!-- compile the common code -->
        <javac srcdir="${src.dir}" destdir="${build.classes.dir}"
               includes="${gwt.common.dir}/**" failonerror="true"
               debug="${compile.debug}" optimize="${compile.optimize}"
               deprecation="${compile.deprecation}">
            <classpath refid="compile.classpath.final" />
        </javac>
        <!-- jar the source and class files -->
        <jar file="${build.jars.dir}/${gwt.common.jar.name}" basedir="${build.classes.dir}" includes="${gwt.common.dir}/**"/>
        <jar update="true" file="${build.jars.dir}/${gwt.common.jar.name}" basedir="${src.dir}" includes="${gwt.common.dir}/**"/>
    </target>

    <!-- Not to be called directly.  Requires parameter ${gwt.module.name} -->
    <target name="gwt-compile-module" depends="set-common-properties">
        <condition property="compile.flag" value="${user.gwt.browser.specific.compile}" else="${gwt.compiler.default}">
            <isset property="user.gwt.browser.specific.compile"/>
        </condition>
        <condition property="gwt-javascript-style" value="${user.gwt.javascript.style}" else="OBF">
            <isset property="user.gwt.javascript.style"/>
        </condition>
        <condition property="gwt.test.ui.flag" value="${user.gwt.test.ui}" else=""> <!-- no value by default -->
            <isset property="user.gwt.test.ui"/>
        </condition>
        <copy todir="${gwt.build.dir}" overwrite="true">
            <fileset dir="${src.dir}">
                <include name="${gwt.module.descriptor}"/>
            </fileset>
        </copy>
        <replace file="${gwt.build.dir}/${gwt.module.descriptor}"
                 token="${gwt.compiler.default}"
                 value="${compile.flag}"/>
        <replace file="${gwt.build.dir}/${gwt.module.descriptor}"
                 token="${gwt.test.ui.default}"
                 value="${gwt.test.ui.flag}"/>
        <java classpathref="compile.classpath.gwt" classname="com.google.gwt.dev.Compiler" fork="true" failonerror="true">
            <jvmarg id=" " value="-Xms128m"/>
            <jvmarg id=" " value="-Xmx384m"/>
            <arg value="-war" />
            <arg value="${gwt.build.dir}" />
            <arg value="-style" />
            <!-- NOTE: using "DETAILED" style causes Java heap space errors -->
            <arg value="${gwt-javascript-style}" />
            <!--<arg value="DETAILED" />-->
            <!-- TODO: auto-detect all GWT modules -->
            <arg value="${gwt.module.name}" />
        </java>
    </target>

    <target name="make-gwt-build-dir">
        <mkdir dir="${gwt.build.dir}"/>
    </target>

    <!-- Helper target to launch the shell on a desired GWT module. Not to be called directly - requires parameter ${gwt.module.name} -->
    <target name="gwt-shell" description="Launch App in GWT shell" depends="setup">
      <java classpathref="compile.classpath.gwt" classname="com.google.gwt.dev.GWTShell" fork="true" spawn="true">
          <arg value="-out"/>
          <arg value="${gwt.build.dir}"/>
          <arg value="${gwt.module.name}" />
      </java>
    </target>

    <target name="gwt-shell-blast" description="Launch Blast in GWT shell" depends="setup">
        <antcall target="gwt-shell">
            <param name="gwt.module.name" value="org.janelia.it.jacs.web.gwt.blast.Blast" />
        </antcall>
    </target>

    <!-- create JAAS jar for Tomcat -->
    <target name="TomcatJaasPlugin" depends="setup, compile, make-jars-dir" description="builds Tomcat JAAS plugin">
        <delete file="${build.jars.dir}/${jaas.plugin.name}" />
        <!-- unjar log4j -->
        <mkdir dir="${build.war.unzipped.dir}/tmp" />
        <unjar src="${common.dir}/Spring/${log4j.name}" dest="${build.war.unzipped.dir}/tmp" overwrite="true"/>
        <!-- build jaas library -->
        <jar destfile="${build.jars.dir}/${jaas.plugin.name}">
              <fileset dir="${build.classes.dir}">
            	<include name="org/janelia/it/jacs/web/security/tomcat/*"/>
              </fileset>
            <fileset dir="${build.war.unzipped.dir}/tmp">
              <include name="org/apache/log4j/**"/>
            </fileset>
        </jar>
        <!-- delete temp files -->
        <delete dir="${build.war.unzipped.dir}/tmp" />
	</target>

    <!-- Build the war -->
    <target name="build-war" depends="setup, make-build-war-dir" description="builds the war file">
        <delete file="${build.war.dir}/${war.name}" />

        <war destfile="${build.war.dir}/${war.name}" webxml="${webroot.dir}/WEB-INF/web.xml" update="false">
            <!-- All the libs -->
            <lib dir="${lib.dir}">
                <include name="*.jar"/>
            </lib>
            <lib dir="${lib.dir}/jfreechart">
                <include name="*.jar"/>
            </lib>
            <lib dir="${build.jars.dir}">
                <include name="*.jar"/>
            </lib>
			<lib dir="${common.dir}/Spring">
				<include name="*.jar"/>
                <exclude name="catalina.jar"/>
            </lib>
            <lib dir="${common.dir}/GWT">
                <include name="gwt-widgets-0.2.0.jar"/>
                <include name="gwt-sl-1.0.jar"/>
                <include name="gwt-servlet.jar"/>
                <include name="gwt-dnd-3.0.1.jar" />
            </lib>
            <lib dir="${common.dir}/JAXB-2.1.5">
                <include name="*.jar"/>
            </lib>
            <!--<lib dir="${common.module}/PostgreSQL-8.1/jdbc">-->
                <!--<include name="postgresql-8.1-404.jdbc3.jar"/>-->
            <!--</lib>-->
            <lib dir="${common.module}/MySQL">
                <include name="mysql-connector-java-5.1.15-bin.jar"/>
            </lib>
            <lib dir="${common.module}/Hibernate-3.2">
                <include name="antlr-2.7.6.jar"/>
            </lib>
            <lib dir="${model.module}/build/jars">
                <include name="jacs-model.jar"/>
            </lib>
            <lib dir="${compute.module}/build/jars">
                <include name="compute-client.jar"/>
            </lib>

            <lib dir="${shared.module}/build/jars">
                <include name="jacs-shared.jar"/>
            </lib>

            <!-- css/* -->
            <zipfileset dir="${webroot.dir}/css" prefix="css">
                <include name="*/**"/>
            </zipfileset>

            <!-- images/* -->
            <zipfileset dir="${webroot.dir}/images" prefix="images">
                <include name="*/**"/>
            </zipfileset>

            <!-- js/* -->
            <zipfileset dir="${webroot.dir}/js" prefix="js">
                <include name="*/**"/>
            </zipfileset>

            <!-- html/* -->
            <zipfileset dir="${webroot.dir}" >
                <include name="*.html"/>
            </zipfileset>

            <!-- favicon.ico -->
            <zipfileset dir="${webroot.dir}" >
                <include name="favicon.ico"/>
            </zipfileset>

            <!-- WEB-INF/* -->
			<zipfileset dir="${webroot.dir}/WEB-INF" prefix="WEB-INF">
                <exclude name="web.*.xml" /> 
            </zipfileset>

            <!-- shared properties -->
            <zipfileset dir="${shared.module}/conf" prefix="WEB-INF/classes" >
                <exclude name="jacs.properties" /> <!-- see next task -->
                <include name="*.properties"/>
            </zipfileset>

            <!-- shared properties -->
            <zipfileset dir="${jacs.properties.dir}" prefix="WEB-INF/classes" >
                <include name="jacs.properties"/>
            </zipfileset>

            <!-- gwt-compiled stuff -->
            <zipfileset dir="${build.dir}/gwt" prefix="gwt"/>
		</war>
    </target>

    <!-- Build the war -->
    <target name="war" depends="setup, gwt-compile, TomcatJaasPlugin, jar, build-war" description="compiles and builds the war file">
	</target>

    <target name="unwar" depends="setup">
        <delete dir="${build.war.unzipped.dir}/" includeemptydirs="true" />
        <mkdir dir="${build.war.unzipped.dir}/${webapp.name}" />
        <unwar src="${build.war.dir}/${war.name}" dest="${build.war.unzipped.dir}/${webapp.name}"/>
    </target>

    <target name="make-build-war-dir">
		<mkdir dir="${build.war.dir}"/>
	</target>
    <target name="build-war-and-deploy" depends="build-war, deploy" description="deploys the war to the web server"/>

    <target name="build-and-deploy" depends="war, deploy" description="deploys the war to the web server"/>
    <target name="deploy" depends="undeploy" description="deploys the war to the web server">
        <copy file="${build.war.dir}/${war.name}" todir="${deploy.dir}" overwrite="true"/>
        <copy file="${build.jars.dir}/${jaas.plugin.name}" todir="${tomcat.home}/lib" overwrite="true"/>
        <copy file="${conf.dir}/${jaas.plugin.config.name}" todir="${tomcat.home}/conf" overwrite="true"/>
    </target>

    <target name="build-and-deploy-as-dir" depends="setup, war, deploy-as-dir" description="deploys the war to the web server"/>
    <target name="deploy-as-dir" depends="setup, unwar, undeploy" description="deploys the war to the web server">
        <copy todir="${deploy.dir}" includeemptydirs="true" overwrite="true">
            <fileset dir="${build.war.unzipped.dir}" includes="**" />
        </copy>
        <copy file="${build.jars.dir}/${jaas.plugin.name}" todir="${tomcat.home}/lib" overwrite="true"/>
        <copy file="${conf.dir}/${jaas.plugin.config.name}" todir="${tomcat.home}/conf" overwrite="true"/>
    </target>

    <target name="undeploy" depends="setup">
        <delete failonerror="false" file="${deploy.dir}/${war.name}" />
        <delete failonerror="false" includeemptydirs="true">
            <fileset dir="${deploy.dir}/${webapp.name}"/>
        </delete>
    </target>

    <!-- Incremental targets for development -->
    <target name="deploy-home" depends="setup">
        <antcall target="deploy-gwt-module">
            <param name="module.path" value="org.janelia.it.jacs.web.gwt.home.Home"/>
            <param name="url.target" value="Home"/>
            <param name="gwt.module.descriptor" value="org/janelia/it/jacs/web/gwt/home/Home.gwt.xml" />
        </antcall>
    </target>
    <target name="deploy-advancedblast" depends="setup">
        <antcall target="deploy-gwt-module">
            <param name="module.path" value="org.janelia.it.jacs.web.gwt.advancedblast.AdvancedBlast"/>
            <param name="url.target" value="AdvancedBlast"/>
            <param name="gwt.module.descriptor" value="org/janelia/it/jacs/web/gwt/advancedblast/AdvancedBlast.gwt.xml" />
        </antcall>
    </target>
    <!--<target name="deploy-psiblast" depends="setup">-->
        <!--<antcall target="deploy-gwt-module">-->
            <!--<param name="module.path" value="org.janelia.it.jacs.web.gwt.psiBlast.PsiBlast"/>-->
            <!--<param name="url.target" value="PsiBlast"/>-->
            <!--<param name="gwt.module.descriptor" value="org/janelia/it/jacs/web/gwt/psiBlast/PsiBlast.gwt.xml" />-->
        <!--</antcall>-->
    <!--</target>-->
    <!--<target name="deploy-reversepsiblast" depends="setup">-->
        <!--<antcall target="deploy-gwt-module">-->
            <!--<param name="module.path" value="org.janelia.it.jacs.web.gwt.reversePsiBlast.ReversePsiBlast"/>-->
            <!--<param name="url.target" value="ReversePsiBlast"/>-->
            <!--<param name="gwt.module.descriptor" value="org/janelia/it/jacs/web/gwt/reversePsiBlast/ReversePsiBlast.gwt.xml" />-->
        <!--</antcall>-->
    <!--</target>-->
    <!--<target name="deploy-ap16s" depends="setup">-->
        <!--<antcall target="deploy-gwt-module">-->
            <!--<param name="module.path" value="org.janelia.it.jacs.web.gwt.ap16s.AnalysisPipeline16S"/>-->
            <!--<param name="url.target" value="AnalysisPipeline16S"/>-->
            <!--<param name="gwt.module.descriptor" value="org/janelia/it/jacs/web/gwt/ap16s/AnalysisPipeline16S.gwt.xml" />-->
        <!--</antcall>-->
    <!--</target>-->
    <!--<target name="deploy-prokAnnotation" depends="setup">-->
        <!--<antcall target="deploy-gwt-module">-->
            <!--<param name="module.path" value="org.janelia.it.jacs.web.gwt.prokAnnot.ProkAnnot"/>-->
            <!--<param name="url.target" value="ProkAnnot"/>-->
            <!--<param name="gwt.module.descriptor" value="org/janelia/it/jacs/web/gwt/prokAnnot/ProkAnnot.gwt.xml" />-->
        <!--</antcall>-->
    <!--</target>-->
    <!--<target name="deploy-eukAnnotation" depends="setup">-->
        <!--<antcall target="deploy-gwt-module">-->
            <!--<param name="module.path" value="org.janelia.it.jacs.web.gwt.eukAnnot.EukAnnot"/>-->
            <!--<param name="url.target" value="EukAnnot"/>-->
            <!--<param name="gwt.module.descriptor" value="org/janelia/it/jacs/web/gwt/eukAnnot/EukAnnot.gwt.xml" />-->
        <!--</antcall>-->
    <!--</target>-->
    <!--<target name="deploy-barcodeDesigner" depends="setup">-->
        <!--<antcall target="deploy-gwt-module">-->
            <!--<param name="module.path" value="org.janelia.it.jacs.web.gwt.barcode.BarCodeDesigner"/>-->
            <!--<param name="url.target" value="BarCodeDesigner"/>-->
            <!--<param name="gwt.module.descriptor" value="org/janelia/it/jacs/web/gwt/barcode/BarCodeDesigner.gwt.xml" />-->
        <!--</antcall>-->
    <!--</target>-->
    <target name="deploy-neuronSeparator" depends="setup">
        <antcall target="deploy-gwt-module">
            <param name="module.path" value="org.janelia.it.jacs.web.gwt.neuronSeparator.NeuronSeparator"/>
            <param name="url.target" value="NeuronSeparator"/>
            <param name="gwt.module.descriptor" value="org/janelia/it/jacs/web/gwt/neuronSeparator/NeuronSeparator.gwt.xml" />
        </antcall>
    </target>
    <!--<target name="deploy-mgAnnotation" depends="setup">-->
        <!--<antcall target="deploy-gwt-module">-->
            <!--<param name="module.path" value="org.janelia.it.jacs.web.gwt.mgAnnot.MgAnnot"/>-->
            <!--<param name="url.target" value="MgAnnot"/>-->
            <!--<param name="gwt.module.descriptor" value="org/janelia/it/jacs/web/gwt/mgAnnot/MgAnnot.gwt.xml" />-->
        <!--</antcall>-->
    <!--</target>-->
    <!--<target name="deploy-profileComparison" depends="setup">-->
        <!--<antcall target="deploy-gwt-module">-->
            <!--<param name="module.path" value="org.janelia.it.jacs.web.gwt.matrix.ProfileComparison"/>-->
            <!--<param name="url.target" value="ProfileComparison"/>-->
            <!--<param name="gwt.module.descriptor" value="org/janelia/it/jacs/web/gwt/matrix/ProfileComparison.gwt.xml" />-->
        <!--</antcall>-->
    <!--</target>-->
    <target name="deploy-neuronalAssayAnalysis" depends="setup">
        <antcall target="deploy-gwt-module">
            <param name="module.path" value="org.janelia.it.jacs.web.gwt.geci.NeuronalAssayAnalysis"/>
            <param name="url.target" value="NeuronalAssayAnalysis"/>
            <param name="gwt.module.descriptor" value="org/janelia/it/jacs/web/gwt/geci/NeuronalAssayAnalysis.gwt.xml" />
        </antcall>
    </target>
    <target name="deploy-tic" depends="setup">
        <antcall target="deploy-gwt-module">
            <param name="module.path" value="org.janelia.it.jacs.web.gwt.tic.TIC"/>
            <param name="url.target" value="TranscriptionImagingConsortium"/>
            <param name="gwt.module.descriptor" value="org/janelia/it/jacs/web/gwt/tic/TIC.gwt.xml" />
        </antcall>
    </target>
    <!--<target name="deploy-zlaticLab" depends="setup">-->
        <!--<antcall target="deploy-gwt-module">-->
            <!--<param name="module.path" value="org.janelia.it.jacs.web.gwt.zlatic.ZlaticLab"/>-->
            <!--<param name="url.target" value="ZlaticLab"/>-->
            <!--<param name="gwt.module.descriptor" value="org/janelia/it/jacs/web/gwt/zlatic/ZlatciLab.gwt.xml" />-->
        <!--</antcall>-->
    <!--</target>-->
    <!--<target name="deploy-intersiteComparisonTool" depends="setup">-->
        <!--<antcall target="deploy-gwt-module">-->
            <!--<param name="module.path" value="org.janelia.it.jacs.web.gwt.ict.IntersiteComparisonTool"/>-->
            <!--<param name="url.target" value="IntersiteComparisonTool"/>-->
            <!--<param name="gwt.module.descriptor" value="org/janelia/it/jacs/web/gwt/ict/IntersiteComparisonTool.gwt.xml" />-->
        <!--</antcall>-->
    <!--</target>-->
    <!--<target name="deploy-degeneratePrimerDesign" depends="setup">-->
        <!--<antcall target="deploy-gwt-module">-->
            <!--<param name="module.path" value="org.janelia.it.jacs.web.gwt.dpd.DegeneratePrimerDesign"/>-->
            <!--<param name="url.target" value="DegeneratePrimerDesign"/>-->
            <!--<param name="gwt.module.descriptor" value="org/janelia/it/jacs/web/gwt/dpd/DegeneratePrimerDesign.gwt.xml" />-->
        <!--</antcall>-->
    <!--</target>-->
    <!--<target name="deploy-closurePrimerDesign" depends="setup">-->
        <!--<antcall target="deploy-gwt-module">-->
            <!--<param name="module.path" value="org.janelia.it.jacs.web.gwt.cpd.ClosurePrimerDesign"/>-->
            <!--<param name="url.target" value="ClosurePrimerDesign"/>-->
            <!--<param name="gwt.module.descriptor" value="org/janelia/it/jacs/web/gwt/cpd/ClosurePrimerDesign.gwt.xml" />-->
        <!--</antcall>-->
    <!--</target>-->
    <target name="deploy-blast" depends="setup">
        <antcall target="deploy-gwt-module">
            <param name="module.path" value="org.janelia.it.jacs.web.gwt.blast.Blast"/>
            <param name="url.target" value="Blast"/>
            <param name="gwt.module.descriptor" value="org/janelia/it/jacs/web/gwt/blast/Blast.gwt.xml" />
        </antcall>
    </target>
    <!--<target name="deploy-frv" depends="setup">-->
        <!--<antcall target="deploy-gwt-module">-->
            <!--<param name="module.path" value="org.janelia.it.jacs.web.gwt.frv.Frv"/>-->
            <!--<param name="url.target" value="Frv"/>-->
            <!--<param name="gwt.module.descriptor" value="org/janelia/it/jacs/web/gwt/frv/Frv.gwt.xml" />-->
        <!--</antcall>-->
    <!--</target>-->
    <!--<target name="deploy-frvdata" depends="setup">-->
        <!--<antcall target="deploy-gwt-module">-->
            <!--<param name="module.path" value="org.janelia.it.jacs.web.gwt.frdata.FRData"/>-->
            <!--<param name="url.target" value="FRData"/>-->
            <!--<param name="gwt.module.descriptor" value="org/janelia/it/jacs/web/gwt/frdata/FRData.gwt.xml" />-->
        <!--</antcall>-->
    <!--</target>-->
    <!--<target name="deploy-inspect" depends="setup">-->
        <!--<antcall target="deploy-gwt-module">-->
            <!--<param name="module.path" value="org.janelia.it.jacs.web.gwt.inspect.Inspect"/>-->
            <!--<param name="url.target" value="Inspect"/>-->
            <!--<param name="gwt.module.descriptor" value="org/janelia/it/jacs/web/gwt/inspect/Inspect.gwt.xml" />-->
        <!--</antcall>-->
    <!--</target>-->
    <!--<target name="deploy-browse-proj-page" depends="setup">-->
        <!--<antcall target="deploy-gwt-module">-->
            <!--<param name="module.path" value="org.janelia.it.jacs.web.gwt.download.BrowseProjectsPage"/>-->
            <!--<param name="url.target" value="BrowseProjectsPage"/>-->
            <!--<param name="gwt.module.descriptor" value="org/janelia/it/jacs/web/gwt/download/BrowseProjectsPage.gwt.xml" />-->
        <!--</antcall>-->
    <!--</target>-->
    <!--<target name="deploy-pubs" depends="setup">-->
        <!--<antcall target="deploy-gwt-module">-->
            <!--<param name="module.path" value="org.janelia.it.jacs.web.gwt.download.DownloadByPubPage"/>-->
            <!--<param name="url.target" value="DownloadByPubPage"/>-->
            <!--<param name="gwt.module.descriptor" value="org/janelia/it/jacs/web/gwt/download/DownloadByPubPage.gwt.xml" />-->
        <!--</antcall>-->
    <!--</target>-->
    <!--<target name="deploy-samples" depends="setup">-->
        <!--<antcall target="deploy-gwt-module">-->
            <!--<param name="module.path" value="org.janelia.it.jacs.web.gwt.download.ProjectSamplesPage"/>-->
            <!--<param name="url.target" value="ProjectSamplesPage"/>-->
            <!--<param name="gwt.module.descriptor" value="org/janelia/it/jacs/web/gwt/download/ProjectSamplesPage.gwt.xml" />-->
        <!--</antcall>-->
    <!--</target>-->
    <target name="deploy-status" depends="setup">
        <antcall target="deploy-gwt-module">
            <param name="module.path" value="org.janelia.it.jacs.web.gwt.status.Status"/>
            <param name="url.target" value="Status"/>
            <param name="gwt.module.descriptor" value="org/janelia/it/jacs/web/gwt/status/Status.gwt.xml" />
        </antcall>
    </target>
    <!--<target name="deploy-gmap" depends="setup">-->
        <!--<antcall target="deploy-gwt-module">-->
            <!--<param name="module.path" value="org.janelia.it.jacs.web.gwt.map.MapTest"/>-->
            <!--<param name="url.target" value="MapTest"/>-->
            <!--<param name="gwt.module.descriptor" value="org/janelia/it/jacs/web/gwt/map/MapTest.gwt.xml" />-->
        <!--</antcall>-->
    <!--</target>-->
    <!--<target name="deploy-admin" depends="setup">-->
        <!--<antcall target="deploy-gwt-module">-->
            <!--<param name="module.path" value="org.janelia.it.jacs.web.gwt.admin.Admin"/>-->
            <!--<param name="url.target" value="Admin"/>-->
            <!--<param name="gwt.module.descriptor" value="org/janelia/it/jacs/web/gwt/admin/Admin.gwt.xml" />-->
        <!--</antcall>-->
    <!--</target>-->
    <!--<target name="deploy-edit-proj" depends="setup">-->
        <!--<antcall target="deploy-gwt-module">-->
            <!--<param name="module.path" value="org.janelia.it.jacs.web.gwt.admin.editproject.EditProject"/>-->
            <!--<param name="url.target" value="EditProject"/>-->
            <!--<param name="gwt.module.descriptor" value="org/janelia/it/jacs/web/gwt/admin/editproject/EditProject.gwt.xml" />-->
        <!--</antcall>-->
    <!--</target>-->
    <!--<target name="deploy-edit-pub" depends="setup">-->
        <!--<antcall target="deploy-gwt-module">-->
            <!--<param name="module.path" value="org.janelia.it.jacs.web.gwt.admin.editpublication.EditPublication"/>-->
            <!--<param name="url.target" value="EditPublication"/>-->
            <!--<param name="gwt.module.descriptor" value="org/janelia/it/jacs/web/gwt/admin/editpublication/EditPublication.gwt.xml" />-->
        <!--</antcall>-->
    <!--</target>-->
    <!--<target name="deploy-detail" depends="setup">-->
        <!--<antcall target="deploy-gwt-module">-->
            <!--<param name="module.path" value="org.janelia.it.jacs.web.gwt.detail.DetailPage"/>-->
            <!--<param name="url.target" value="DetailPage"/>-->
            <!--<param name="gwt.module.descriptor" value="org/janelia/it/jacs/web/gwt/detail/DetailPage.gwt.xml" />-->
        <!--</antcall>-->
    <!--</target>-->
   <!--<target name="deploy-search" depends="setup">-->
        <!--<antcall target="deploy-gwt-module">-->
            <!--<param name="module.path" value="org.janelia.it.jacs.web.gwt.search.Search"/>-->
            <!--<param name="url.target" value="Search"/>-->
            <!--<param name="gwt.module.descriptor" value="org/janelia/it/jacs/web/gwt/search/Search.gwt.xml" />-->
        <!--</antcall>-->
    <!--</target>-->
    <target name="deploy-header" depends="setup">
        <antcall target="deploy-gwt-module">
            <param name="module.path" value="org.janelia.it.jacs.web.gwt.header.Header"/>
            <param name="url.target" value="Header"/>
            <param name="gwt.module.descriptor" value="org/janelia/it/jacs/web/gwt/header/Header.gwt.xml" />
        </antcall>
    </target>
    <target name="deploy-test" depends="setup">
        <antcall target="deploy-gwt-module">
            <param name="module.path" value="org.janelia.it.jacs.web.gwt.test.Test"/>
            <param name="url.target" value="Test"/>
            <param name="gwt.module.descriptor" value="org/janelia/it/jacs/web/gwt/test/Test.gwt.xml" />
        </antcall>
    </target>

    <!-- Compiles and deploys one GWT module.  Requires param ${module.path}. Assumes deploy-as-dir was previously run -->
    <target name="deploy-gwt-module" depends="setup">
        <antcall target="gwt-compile-module">
            <param name="gwt.module.name" value="${module.path}" />
        </antcall>
        <copy todir="${deploy.dir}/${webapp.name}/gwt" includeemptydirs="true" overwrite="true">
            <fileset dir="${gwt.build.dir}" includes="${url.target}/**" />
        </copy>
    </target>

    <target name="deploy-css" depends="setup">
        <copy todir="${deploy.dir}/${webapp.name}/css" includeemptydirs="true" overwrite="true">
            <fileset dir="${css.dir}" includes="**" />
        </copy>
    </target>
    <target name="deploy-images" depends="setup">
        <copy todir="${deploy.dir}/${webapp.name}/images" includeemptydirs="true" overwrite="true">
            <fileset dir="${images.dir}" includes="**" />
        </copy>
    </target>
    <target name="deploy-jsps" depends="setup">
        <copy todir="${deploy.dir}/${webapp.name}/WEB-INF/jsp" includeemptydirs="true" overwrite="true">
            <fileset dir="${jsp.dir}" includes="**" />
        </copy>
    </target>
    <target name="deploy-js" depends="setup">
        <copy todir="${deploy.dir}/${webapp.name}/js" includeemptydirs="true" overwrite="true">
            <fileset dir="${js.dir}" includes="**" />
        </copy>
    </target>

    <!-- deploys to camweb area -->
    <target name="get-user-input-for-deployment" unless="server.password">
        <!--<input message="Please enter password:" addproperty="server.password" />-->
    </target>

    <!--<target name="deploy-camweb" depends="get-user-input-for-deployment" description="Deploy war to camweb servers">-->
        <!--<antcall target="deploy-camweb-8080">-->
            <!--<param name="server.password" value="${server.password}"/>-->
        <!--</antcall>-->
        <!--<antcall target="deploy-camweb-9080">-->
            <!--<param name="server.password" value="${server.password}"/>-->
        <!--</antcall>-->
    <!--</target>-->

    <target name="deploy-[your-server]-dev" depends="setup" description="Deploy ear and jars to development server">
        <condition property="host.provided">
            <isset property="user.server.machine"/>
        </condition>
        <antcall target="setHost"/>
        <antcall target='getHost'/>
    </target>

    <target name="getHost" unless="host.provided" description="Ping the user for a host">
        <input message="Please enter server name, or set your user.server.machine property:" addproperty="server.address" />
        <input message="Please enter password for saffordt:" addproperty="server.password" />
        <antcall target="deploy-server"/>
    </target>

    <target name="setHost" if="host.provided" description="Set the known host value">
        <echo message="Setting the host to ${user.server.machine}, provided by the user.properties file"/>
        <property name="server.address" value="${user.server.machine}"/>
        <echo message="server.address is now ${server.address}"/>
        <antcall target="deploy-server"/>
    </target>

    <target name="deploy-server" description="Push the server code to the host provided">
        <echo message="Checking ${jacs.properties.dir}/${server.address}.properties for existance" />
        <condition property="deployment-specific.properties.file.name"
                   value="${server.address}.properties"
                   else="jacs.properties" >
            <available file="${jacs.properties.dir}/${server.address}.properties" />
        </condition>

        <echo message="Overlay properties file: ${deployment-specific.properties.file.name}" />
        <antcall target="deploy-tomcat-app">
            <param name="ssh.common.params" value="${user.server.login}@${server.address}"/>
            <param name="scp.common.params" value=""/>
            <param name="server.username" value="${user.server.login}" />
            <param name="deployment-specific.properties.dir" value="${jacs.properties.dir}"/>
            <param name="deployment-specific.properties.file" value="${deployment-specific.properties.file.name}"/>
        </antcall>
    </target>

    <target name="deploy-tomcat-app" depends="setup">
        <!-- set connection params, and check connection -->
        <echo message="Testing connection" />
        <exec executable="${ssh}" description="Testing connection"
              outputproperty="exec.output" failonerror="true">
            <arg line="${ssh.common.params} ls -ld /tmp"/>
        </exec>

        <!-- make temp dir -->
        <property name="temp.dir" value="${build.dir}/tmp" />
        <mkdir dir="${temp.dir}" />

        <!-- rebuild jacs.properties -->
        <!-- need to copy to circumvent bug in FileSet type - ordering of includes alphabetically, and not in order specified -->
        <copy file="${jacs.properties.dir}/jacs.properties" tofile="${temp.dir}/000-jacs.properties" />
        <copy file="${jacs.properties.dir}/${deployment-specific.properties.file}" tofile="${temp.dir}/${deployment-specific.properties.file}" />
    	<properties file="${temp.dir}/jacs.properties">
          <header>
            Ant-generated file
          </header>
            <!--
              merge all property files in directory deploy
            -->
          <merge dir="${temp.dir}" >
              <include name="000-jacs.properties" />
              <include name="${deployment-specific.properties.file}"/>
          </merge>
        </properties>

        <!-- read in properties -->
        <property file="${temp.dir}/jacs.properties" prefix="FromPropFile"/>
        <property name="tomcat.home" value="${FromPropFile.ServerRoot.Dir}/apache-tomcat-7.0.5" />

        <!--build war file -->
        <antcall target="build-war" >
            <param name="jacs.properties.dir" value="${temp.dir}"/>
            <param name="build.war.dir" value="${temp.dir}"/>
        </antcall>

         <!--stop tomcat server and give it time to shutdown-->

        <sequential >
            <echo message="Shutting down Tomcat..." />
            <exec executable="${ssh}" description="Shutting down Tomcat"
                  outputproperty="exec.output">
                <arg line="${ssh.common.params} /groups/jacs/jacsHosts/bin/stoptomcat.sh ${tomcat.home}"/>
            </exec>
            <echo message="Done : ${exec.output}"  />
        </sequential>
         <!--clean out temp files -->
        <echo message="Removing application directory" />
        <exec executable="${ssh}" description="Removing application directory">
            <arg line="${ssh.common.params} rm -fr ${tomcat.home}/webapps/${webapp.name}"/>
        </exec>
        <echo message="Removing application war file" />
        <exec executable="${ssh}" description="Removing application war file">
            <arg line="${ssh.common.params} rm -f ${tomcat.home}/webapps/${war.name}"/>
        </exec>
        <echo message="Removing Tomcat temp directory" />
        <exec executable="${ssh}" description="Removing Tomcat temp directory">
            <arg line="${ssh.common.params} rm -fr ${tomcat.home}/work/Catalina/localhost/${webapp.name}"/>
        </exec>

         <!--copy war file -->
        <echo message="Copying war file to server" />
        <exec executable="${scp}" description="Publishing war file">
            <arg line="${scp.common.params} ${temp.dir}/${war.name} ${server.username}@${server.address}:${tomcat.home}/webapps/${war.name}"/>
        </exec>

         <!--restart tomcat -->
        <echo message="Starting Tomcat (/groups/jacs/jacsHosts/bin/starttomcat.sh ${tomcat.home})" />
        <exec executable="${ssh}" description="Starting Tomcat"
              outputproperty="exec.output">
            <arg line="${ssh.common.params} /groups/jacs/jacsHosts/bin/starttomcat.sh ${tomcat.home}"/>
        </exec>

         <!-- remove temp files 
         <delete dir="${temp.dir}"/>
         -->
    </target>

</project>
